<script>
    // --- Estado Global ---
    // [CORREÇÃO] Usamos 'var' em vez de 'let' para evitar erro de "Identifier already declared"
    // ao navegar entre abas (pois o script é re-executado na mesma janela).
    var listaNotas = [];
    var notaSelecionada = null;
    var setoresCache = [];

    /**
    * Define as datas dos filtros para os últimos 3 dias automaticamente.
    * OBS: O formato OBRIGATÓRIO para input type="date" via JS é YYYY-MM-DD.
    * O navegador exibirá como DD/MM/AAAA automaticamente para o usuário.
    */
    function NotasFiscaisScript_inicializarFiltroDatas() {
        const inputInicio = document.getElementById('filtroDataInicio');
        const inputFim = document.getElementById('filtroDataFim');

        if (!inputInicio || !inputFim) return;

        const hoje = new Date();
        const tresDiasAtras = new Date();
        tresDiasAtras.setDate(hoje.getDate() - 3);

        // Formata para YYYY-MM-DD
        const formatarParaInputDate = (data) => {
            const ano = data.getFullYear();
            // PadStart garante que 1 vire 01, etc.
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        };

        const dataFimStr = formatarParaInputDate(hoje);
        const dataInicioStr = formatarParaInputDate(tresDiasAtras);

        // Define os valores
        inputInicio.value = dataInicioStr;
        inputFim.value = dataFimStr;
        
        console.log(`Datas definidas via Script: ${dataInicioStr} até ${dataFimStr}`);
    }

    // --- Função Principal de Inicialização ---
    function initNotasFiscais() {
        console.log("Sistema de Notas Fiscais Iniciado (Modo SPA com Persistência)");

        const storageKey = 'CotacaoPro_NotasFiscais_Filtros';
        const filtrosSalvos = sessionStorage.getItem(storageKey);
        let filtrosRestaurados = false;

        // Tenta restaurar filtros anteriores
        if (filtrosSalvos) {
            try {
                const filtros = JSON.parse(filtrosSalvos);
                
                // Restaura Busca (mesmo se for string vazia)
                const elBusca = document.getElementById('filtroBusca');
                if (elBusca && filtros.busca !== undefined) elBusca.value = filtros.busca;

                // Restaura Status
                const elStatus = document.getElementById('filtroStatus');
                if (elStatus && filtros.status !== undefined) elStatus.value = filtros.status;

                // Restaura Datas (Essenciais)
                const elInicio = document.getElementById('filtroDataInicio');
                const elFim = document.getElementById('filtroDataFim');
                
                if (elInicio && elFim && filtros.dataInicio && filtros.dataFim) {
                    elInicio.value = filtros.dataInicio;
                    elFim.value = filtros.dataFim;
                    filtrosRestaurados = true;
                    console.log("Filtros restaurados da sessão:", filtros);
                }
            } catch (e) {
                console.warn("Erro ao restaurar filtros, limpando storage:", e);
                sessionStorage.removeItem(storageKey);
            }
        }

        // Se não foi possível restaurar (1ª vez ou cache limpo), aplica o padrão de 3 dias
        if (!filtrosRestaurados) {
            console.log("Aplicando filtros padrão (3 dias).");
            NotasFiscaisScript_inicializarFiltroDatas();
        }

        // Configura o listener de busca (Remove clones para evitar duplicidade de eventos)
        const filtroBuscaEl = document.getElementById('filtroBusca');
        if (filtroBuscaEl) {
            const novoFiltro = filtroBuscaEl.cloneNode(true);
            filtroBuscaEl.parentNode.replaceChild(novoFiltro, filtroBuscaEl);
            
            novoFiltro.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') carregarNotas();
            });
            
            // Se houver texto recuperado, foca no campo
            if (novoFiltro.value) {
                setTimeout(() => novoFiltro.focus(), 100);
            }
        }

        // Carrega a lista de setores para o datalist
        carregarSetores();

        // Dispara a busca inicial (agora com filtros garantidos)
        carregarNotas();
    }

    // --- Helpers (Formatadores) ---

    // Converte "R$ 1.200,50" ou "1200,50" para "1200.50" (aceito pelo input type=number)
    function parseValorParaInput(valor) {
        if (!valor) return '';
        if (typeof valor === 'number') return valor; // Já é numero

        let v = String(valor).trim();
        // Remove R$ e espaços
        v = v.replace('R$', '').trim();
        // Se tiver ponto e vírgula (ex: 1.000,00), remove ponto e troca vírgula
        if (v.includes('.') && v.includes(',')) {
            v = v.replace(/\./g, '').replace(',', '.');
        } else if (v.includes(',')) {
            // Só vírgula (ex: 1000,00)
            v = v.replace(',', '.');
        }
        return v;
    }

    // Converte Data "DD/MM/YYYY" ou ISO para "YYYY-MM-DD" (aceito pelo input type=date)
    function parseDataParaInput(data) {
        if (!data) return '';
        let d = String(data).trim();

        // Se for ISO (2025-11-19T...)
        if (d.includes('T')) return d.split('T')[0];

        // Se for formato BR (19/11/2025)
        if (d.includes('/')) {
            const partes = d.split('/');
            if (partes.length === 3) {
                // Retorna YYYY-MM-DD
                return `${partes[2]}-${partes[1]}-${partes[0]}`;
            }
        }
        return d; // Tenta retornar como está se não reconhecer
    }

    // --- Funções UI ---

    function toggleLoader(show) {
        const loader = document.getElementById('loader');
        if (show) loader.classList.remove('hidden');
        else loader.classList.add('hidden');
    }

    function fecharModal(id) {
        document.getElementById(id).classList.add('hidden');
    }

    // --- Lógica de Seleção ---

    function selecionarLinha(tr, nota) {
        document.querySelectorAll('.linha-selecionada').forEach(el => {
            el.classList.remove('linha-selecionada');
        });

        if (notaSelecionada && notaSelecionada.chaveAcesso === nota.chaveAcesso) {
            notaSelecionada = null;
            atualizarActionBar();
            return;
        }

        tr.classList.add('linha-selecionada');
        notaSelecionada = nota;
        atualizarActionBar();
    }

    function atualizarActionBar() {
        const btns = ['btnClassificar', 'btnDesfazer', 'btnFinanceiro'];
        const statusDiv = document.getElementById('statusSelecao');

        if (notaSelecionada) {
            btns.forEach(id => document.getElementById(id).removeAttribute('disabled'));
            statusDiv.innerHTML = `Selecionada: <strong>${notaSelecionada.numeroNF}</strong> - ${notaSelecionada.nomeEmitente}`;
            statusDiv.classList.remove('text-gray-500', 'italic');
            statusDiv.classList.add('text-blue-600');
        } else {
            btns.forEach(id => document.getElementById(id).setAttribute('disabled', 'true'));
            statusDiv.innerText = 'Nenhuma nota selecionada';
            statusDiv.classList.add('text-gray-500', 'italic');
            statusDiv.classList.remove('text-blue-600');
        }
    }

    // --- Carregamento ---

    async function carregarNotas() {
        // Referências aos elementos
        const elBusca = document.getElementById('filtroBusca');
        const elStatus = document.getElementById('filtroStatus');
        let elInicio = document.getElementById('filtroDataInicio');
        let elFim = document.getElementById('filtroDataFim');

        // Verifica se elementos existem (segurança contra erros de DOM)
        if (!elInicio || !elFim) {
            console.error("Elementos de data não encontrados no DOM.");
            return;
        }

        // --- TRAVA DE SEGURANÇA ---
        // Se datas estiverem vazias, força reinicialização padrão
        if (!elInicio.value || !elFim.value) {
            console.warn("Datas vazias detectadas na busca. Reinicializando padrão...");
            NotasFiscaisScript_inicializarFiltroDatas();
            
            // Verifica novamente após tentar preencher
            if (!elInicio.value || !elFim.value) {
                console.error("Abortando busca: Datas obrigatórias continuam vazias.");
                return; 
            }
        }

        // --- PERSISTÊNCIA (SALVAR) ---
        // Salva o estado atual para a próxima visita
        const estadoFiltros = {
            busca: elBusca ? elBusca.value : '',
            status: elStatus ? elStatus.value : '',
            dataInicio: elInicio.value,
            dataFim: elFim.value
        };
        sessionStorage.setItem('CotacaoPro_NotasFiscais_Filtros', JSON.stringify(estadoFiltros));
        // ---------------------------

        toggleLoader(true);
        notaSelecionada = null;
        atualizarActionBar();

        try {
            const params = new URLSearchParams({
                busca: estadoFiltros.busca,
                status: estadoFiltros.status,
                dataInicio: estadoFiltros.dataInicio,
                dataFim: estadoFiltros.dataFim
            });

            const res = await fetch(`/api/notasfiscais/listar?${params}`);
            const json = await res.json();

            if (json.success) {
                listaNotas = json.dados;
                renderizarTabela(listaNotas);
            } else {
                alert('Erro ao buscar notas: ' + json.message);
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão ao buscar notas.');
        } finally {
            toggleLoader(false);
        }
    }

    function renderizarTabela(dados) {
        const tbody = document.getElementById('tabelaNotasBody');
        const contador = document.getElementById('contadorRegistros');
        tbody.innerHTML = '';

        if (dados.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Nenhuma nota encontrada.</td></tr>`;
            contador.innerText = "0 registros";
            return;
        }

        dados.forEach(nf => {
            const tr = document.createElement('tr');

            let badgeClass = 'bg-gray-100 text-gray-600';
            if (nf.statusConciliacao === 'Conciliada') badgeClass = 'bg-green-100 text-green-700 border border-green-200';
            else if (nf.statusConciliacao === 'Pendente') badgeClass = 'bg-yellow-100 text-yellow-700 border border-yellow-200';
            else if (nf.statusConciliacao === 'Bonificação') badgeClass = 'bg-purple-100 text-purple-700 border border-purple-200';
            else if (nf.statusConciliacao && nf.statusConciliacao.includes('Sem Pedido')) badgeClass = 'bg-orange-100 text-orange-700 border border-orange-200';

            const valor = parseFloat(nf.valorTotalNF || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            tr.innerHTML = `
                <td class="px-4 py-3 font-medium text-gray-900 border-b border-gray-100">${nf.numeroNF}</td>
                <td class="px-4 py-3 text-gray-700 border-b border-gray-100 truncate max-w-xs" title="${nf.nomeEmitente}">${nf.nomeEmitente}</td>
                <td class="px-4 py-3 text-gray-500 border-b border-gray-100 text-xs">${nf.cnpjEmitente}</td>
                <td class="px-4 py-3 text-gray-700 border-b border-gray-100">${nf.dataEmissao}</td>
                <td class="px-4 py-3 text-center border-b border-gray-100">
                    <span class="px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${badgeClass}">${nf.statusConciliacao || 'N/A'}</span>
                </td>
                <td class="px-4 py-3 text-right font-bold text-gray-800 border-b border-gray-100">${valor}</td>
            `;
            tr.onclick = () => selecionarLinha(tr, nf);
            tbody.appendChild(tr);
        });

        contador.innerText = `${dados.length} registros`;
    }

    async function carregarSetores() {
        try {
            const res = await fetch('/api/notasfiscais/setores-rateio');
            const json = await res.json();
            if (json.success) {
                setoresCache = json.dados || [];
                const datalist = document.getElementById('listaSetores');
                datalist.innerHTML = '';
                setoresCache.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    datalist.appendChild(opt);
                });
            }
        } catch (e) { console.warn("Falha ao carregar setores", e); }
    }

    // --- Funções: MODAIS ---

    function abrirModalClassificacao() {
        if (!notaSelecionada) return;
        document.getElementById('inputClassificarStatus').value = notaSelecionada.statusConciliacao || 'Pendente';
        document.getElementById('modalClassificar').classList.remove('hidden');
    }

    async function salvarClassificacao() {
        if (!notaSelecionada) return;
        const novoStatus = document.getElementById('inputClassificarStatus').value;
        toggleLoader(true);
        fecharModal('modalClassificar');

        try {
            const res = await fetch('/api/notasfiscais/atualizar-status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chaveAcesso: notaSelecionada.chaveAcesso, novoStatus })
            });
            const json = await res.json();
            if (json.success) {
                alert(json.message);
                carregarNotas();
            } else {
                alert('Erro: ' + json.message);
            }
        } catch (e) { alert('Erro de comunicação.'); }
        finally { toggleLoader(false); }
    }

    function abrirModalDesfazer() {
        if (!notaSelecionada) return;
        if (notaSelecionada.statusConciliacao === 'Pendente') {
            alert('Esta nota já está Pendente.');
            return;
        }
        document.getElementById('modalDesfazer').classList.remove('hidden');
    }

    async function executarDesfazer() {
        if (!notaSelecionada) return;
        toggleLoader(true);
        fecharModal('modalDesfazer');

        try {
            const res = await fetch('/api/notasfiscais/desfazer-conciliacao', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chaveAcesso: notaSelecionada.chaveAcesso,
                    numeroNF: notaSelecionada.numeroNF
                })
            });
            const json = await res.json();
            if (json.success) {
                alert(json.message);
                carregarNotas();
            } else {
                alert('Erro ao desfazer: ' + json.message);
            }
        } catch (e) { alert('Erro crítico ao desfazer.'); }
        finally { toggleLoader(false); }
    }

    // --- FINANCEIRO ---

    async function abrirModalFinanceiro() {
        if (!notaSelecionada) return;

        toggleLoader(true);
        document.getElementById('lblFinanceiroChave').innerText = `Chave: ${notaSelecionada.chaveAcesso}`;
        document.getElementById('tbodyFaturas').innerHTML = '';
        document.getElementById('tbodyContas').innerHTML = '';

        try {
            const res = await fetch(`/api/notasfiscais/resumo-financeiro/${notaSelecionada.chaveAcesso}`);
            const json = await res.json();

            if (json.success) {
                const { faturas, contasAPagar } = json.dados;
                // Carrega as tabelas
                if (faturas) faturas.forEach(f => adicionarLinhaFatura(f));
                if (contasAPagar) contasAPagar.forEach(c => adicionarLinhaConta(c));

                document.getElementById('modalFinanceiro').classList.remove('hidden');
            } else {
                alert('Erro ao carregar dados financeiros.');
            }
        } catch (e) {
            console.error(e);
            alert('Erro de conexão.');
        } finally {
            toggleLoader(false);
        }
    }

    function createInput(value, type = 'text', placeholder = '', list = '') {
        const input = document.createElement('input');
        input.type = type;
        // Se for number, adiciona step para aceitar centavos
        if (type === 'number') input.step = "0.01";
        input.className = "w-full border-gray-300 rounded text-xs px-2 py-1 focus:ring-blue-500 focus:border-blue-500 border";
        input.value = value || '';
        input.placeholder = placeholder;
        if (list) input.setAttribute('list', list);
        return input;
    }

    function createBtnRemove(tr) {
        const btn = document.createElement('button');
        btn.className = "text-red-500 hover:text-red-700 p-1";
        btn.innerHTML = '<i class="fas fa-trash"></i>';
        btn.onclick = () => tr.remove();
        return btn;
    }

    function adicionarLinhaFatura(dados = {}) {
        const tbody = document.getElementById('tbodyFaturas');
        const tr = document.createElement('tr');

        // Tratamento de Data
        const rawVenc = dados['Data de Vencimento'] || dados['Vencimento'];
        const venc = parseDataParaInput(rawVenc);

        // Tratamento de Valor
        const rawVal = dados['Valor da Parcela'] || dados['Valor'];
        const val = parseValorParaInput(rawVal);

        const td1 = document.createElement('td'); td1.className = "p-1";
        td1.appendChild(createInput(dados['Número da Parcela'] || '', 'text', 'Ex: 1/3'));

        const td2 = document.createElement('td'); td2.className = "p-1";
        td2.appendChild(createInput(venc, 'date'));

        const td3 = document.createElement('td'); td3.className = "p-1";
        td3.appendChild(createInput(val, 'number', '0.00'));

        const td4 = document.createElement('td'); td4.className = "p-1 text-center";
        td4.appendChild(createBtnRemove(tr));

        tr.append(td1, td2, td3, td4);
        tbody.appendChild(tr);
    }

    function adicionarLinhaConta(dados = {}) {
        const tbody = document.getElementById('tbodyContas');
        const tr = document.createElement('tr');

        // Tratamento de Data
        const rawVenc = dados['Data de Vencimento'] || dados['Vencimento'];
        const venc = parseDataParaInput(rawVenc);

        // Tratamento de Valor
        // Tenta pegar 'Valor por Setor' primeiro, depois 'Valor Rateado', depois 'Valor'
        const rawVal = dados['Valor por Setor'] || dados['Valor Rateado'] || dados['Valor'];
        const val = parseValorParaInput(rawVal);

        const td1 = document.createElement('td'); td1.className = "p-1";
        td1.appendChild(createInput(dados['Resumo dos Itens'] || dados['Resumo/Título'] || '', 'text', 'Descrição'));

        const td2 = document.createElement('td'); td2.className = "p-1";
        td2.appendChild(createInput(dados['Setor'] || '', 'text', 'Setor', 'listaSetores'));

        const td3 = document.createElement('td'); td3.className = "p-1";
        td3.appendChild(createInput(venc, 'date'));

        const td4 = document.createElement('td'); td3.className = "p-1";
        td4.appendChild(createInput(val, 'number', '0.00'));

        const td5 = document.createElement('td'); td5.className = "p-1 text-center";
        td5.appendChild(createBtnRemove(tr));

        tr.append(td1, td2, td3, td4, td5);
        tbody.appendChild(tr);
    }

    async function salvarFinanceiro() {
        if (!notaSelecionada) return;

        const faturas = [];
        document.querySelectorAll('#tbodyFaturas tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            if (inputs.length > 0) {
                faturas.push({
                    'Chave de Acesso': notaSelecionada.chaveAcesso,
                    'Número da Fatura': notaSelecionada.numeroNF,
                    'Número da Parcela': inputs[0].value,
                    'Data de Vencimento': inputs[1].value,
                    'Valor da Parcela': inputs[2].value
                });
            }
        });

        const contas = [];
        document.querySelectorAll('#tbodyContas tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            if (inputs.length > 0) {
                contas.push({
                    'Chave de Acesso': notaSelecionada.chaveAcesso,
                    'Número da Fatura': notaSelecionada.numeroNF,
                    'Resumo dos Itens': inputs[0].value,
                    'Setor': inputs[1].value,
                    'Data de Vencimento': inputs[2].value,
                    'Valor por Setor': inputs[3].value,
                    'Número da Parcela': 'Manual',
                    'Valor da Parcela': inputs[3].value
                });
            }
        });

        toggleLoader(true);

        try {
            const p1 = fetch('/api/notasfiscais/salvar-faturas', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chaveAcesso: notaSelecionada.chaveAcesso, faturas })
            });

            const p2 = fetch('/api/notasfiscais/salvar-contas-pagar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chaveAcesso: notaSelecionada.chaveAcesso, linhas: contas })
            });

            const [r1, r2] = await Promise.all([p1, p2]);
            const j1 = await r1.json();
            const j2 = await r2.json();

            if (j1.success && j2.success) {
                alert('Financeiro salvo com sucesso!');
                fecharModal('modalFinanceiro');
                carregarNotas();
            } else {
                alert(`Erro: Faturas: ${j1.message || 'OK'} | Contas: ${j2.message || 'OK'}`);
            }
        } catch (e) {
            console.error(e);
            alert('Erro ao salvar dados.');
        } finally {
            toggleLoader(false);
        }
    }

        // --- Execução Imediata ---
    // Como a tela é carregada dinamicamente, executamos a função diretamente.
    initNotasFiscais();
</script>

