<script>
    //####################################################################################################
    // MÓDULO: ETAPAS (CLIENT-SIDE) - EtapasScript.ejs
    // Funções relacionadas às etapas da cotação.
    // VERSÃO CORRIGIDA COM SELETORES DE MODAL ROBUSTOS
    //####################################################################################################

    /**
     * @file EtapasScript.ejs
     * @description Lógica client-side para as funcionalidades do menu "Etapas".
     */

    const EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO = [
        "SubProduto", "Preço", "Preço por Fator", "Comprar", "Valor Total", "Empresa Faturada"
    ];
    
    let EtapasScript_empresasParaFaturamento = [];
    let EtapasScript_pedidosMinimosFornecedores = {};
    let EtapasScript_debounceTimer = null;

    //----------------------------------------------------------------------------------------------------
    // ETAPA 1: CONTAGEM DE ESTOQUE (MODAL)
    //----------------------------------------------------------------------------------------------------

    /**
     * Ponto de entrada para a Etapa 1. Prepara e exibe o modal de Contagem de Estoque.
     */
    function EtapasScript_ativarModoContagemEstoque() {
        console.log("EtapasScript: Ativando modo Contagem de Estoque (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'contagem_estoque';

        if (window.CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
            window.CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
            CotacaoIndividualScript_modoEtapaAtual = null;
            return;
        }

        const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
        if (!modalOverlay) {
            console.error("Modal de Contagem de Estoque não encontrado.");
            return;
        }

        EtapasScript_renderizarConteudoModalContagem(modalOverlay);
        modalOverlay.classList.add('active');
        
        // Remove listeners antigos (se existirem) para evitar duplicação
        const btnSalvar = modalOverlay.querySelector('#EtapasScript_btnSalvarModalContagem');
        const btnCancelar = modalOverlay.querySelector('#EtapasScript_btnCancelarModalContagem');
        const btnFechar = modalOverlay.querySelector('#EtapasScript_btnFecharModalContagemEstoque');

        btnSalvar.replaceWith(btnSalvar.cloneNode(true));
        btnCancelar.replaceWith(btnCancelar.cloneNode(true));
        btnFechar.replaceWith(btnFechar.cloneNode(true));

        // Adiciona os novos event listeners
        modalOverlay.querySelector('#EtapasScript_btnSalvarModalContagem').addEventListener('click', EtapasScript_salvarContagemEstoqueEtapa);
        modalOverlay.querySelector('#EtapasScript_btnCancelarModalContagem').addEventListener('click', EtapasScript_fecharModalContagemEstoque);
        modalOverlay.querySelector('#EtapasScript_btnFecharModalContagemEstoque').addEventListener('click', EtapasScript_fecharModalContagemEstoque);
    }

    /**
     * Fecha o modal de contagem de estoque.
     */
    function EtapasScript_fecharModalContagemEstoque() {
        console.log("EtapasScript: Fechando modal de Contagem de Estoque.");
        const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
            const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalContagem');
            if (feedbackDiv) feedbackDiv.innerHTML = '';
        }
        CotacaoIndividualScript_modoEtapaAtual = null;
    }

    /**
     * Renderiza o corpo da tabela dentro do modal de contagem de estoque.
     * @param {HTMLElement} modalOverlay O elemento do modal.
     */
    function EtapasScript_renderizarConteudoModalContagem(modalOverlay) {
        const tbody = modalOverlay.querySelector('#EtapasScript_tbodyModalContagemEstoque');
        if (!tbody) {
            console.error("EtapasScript_renderizarConteudoModalContagem: Tbody do modal não encontrado.");
            return;
        }
        tbody.innerHTML = ''; 

        const produtosPrincipais = {};
        window.CotacaoIndividualScript_dadosOriginaisCotacao.forEach(item => {
            const nomeProduto = item.Produto;
            if (!produtosPrincipais[nomeProduto]) {
                produtosPrincipais[nomeProduto] = {
                    nome: nomeProduto,
                    estoqueMinimo: (item.EstoqueMinimoProdutoPrincipal !== null && item.EstoqueMinimoProdutoPrincipal !== undefined)
                        ? item.EstoqueMinimoProdutoPrincipal : '',
                    dadosEstoqueCompra: window.CotacaoIndividualScript_parsearStringEstoqueComprar(item["Estoque Atual"])
                };
            }
        });
        const listaProdutos = Object.values(produtosPrincipais).sort((a, b) => a.nome.localeCompare(b.nome));

        if (listaProdutos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhum produto na cotação.</td></tr>';
            return;
        }

        listaProdutos.forEach(produto => {
            const tr = tbody.insertRow();
            tr.dataset.produtoNome = produto.nome;
            tr.insertCell().textContent = produto.nome;
            const tdEstMin = tr.insertCell();
            const inputEstMin = document.createElement('input');
            inputEstMin.type = 'number';
            inputEstMin.className = 'input-contagem input-estoque-min-prod-principal w-full p-2 border border-gray-300 rounded-md';
            inputEstMin.style.cssText = "width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;";
            inputEstMin.placeholder = 'Ex: 10';
            inputEstMin.value = produto.estoqueMinimo;
            tdEstMin.appendChild(inputEstMin);
            const tdEstContado = tr.insertCell();
            const inputEstContado = document.createElement('input');
            inputEstContado.type = 'number';
            inputEstContado.className = 'input-contagem input-estoque-contado-prod-principal w-full p-2 border border-gray-300 rounded-md';
            inputEstContado.style.cssText = "width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;";
            inputEstContado.placeholder = 'Ex: 15';
            inputEstContado.value = produto.dadosEstoqueCompra.estoqueAtual !== null ? produto.dadosEstoqueCompra.estoqueAtual : '';
            tdEstContado.appendChild(inputEstContado);
            const tdComprar = tr.insertCell();
            const inputComprar = document.createElement('input');
            inputComprar.type = 'number';
            inputComprar.className = 'input-contagem input-comprar-sugestao-prod-principal w-full p-2 border border-gray-300 rounded-md';
            inputComprar.style.cssText = "width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;";
            inputComprar.placeholder = 'Ex: 5';
            inputComprar.value = produto.dadosEstoqueCompra.comprar !== null ? produto.dadosEstoqueCompra.comprar : '';
            tdComprar.appendChild(inputComprar);
        });
    }

    /**
     * Coleta os dados dos inputs do modal e os envia para a API Node.js.
     */
    async function EtapasScript_salvarContagemEstoqueEtapa() {
        console.log("EtapasScript: Coletando dados do modal para salvar.");
        
        const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
        if (!modalOverlay) return;

        const dadosParaSalvar = [];
        modalOverlay.querySelectorAll('#EtapasScript_tbodyModalContagemEstoque tr').forEach(row => {
            const produtoNome = row.dataset.produtoNome;
            if (!produtoNome) return;
            const inputEstMinElem = row.querySelector('.input-estoque-min-prod-principal');
            const inputEstContadoElem = row.querySelector('.input-estoque-contado-prod-principal');
            const inputComprarSugElem = row.querySelector('.input-comprar-sugestao-prod-principal');
            const novoEstoqueMinimo = (inputEstMinElem && inputEstMinElem.value !== '') ? parseFloat(inputEstMinElem.value.replace(',', '.')) : null;
            const estoqueContado = (inputEstContadoElem && inputEstContadoElem.value !== '') ? parseFloat(inputEstContadoElem.value.replace(',', '.')) : null;
            const comprarSugestao = (inputComprarSugElem && inputComprarSugElem.value !== '') ? parseFloat(inputComprarSugElem.value.replace(',', '.')) : null;
            if (novoEstoqueMinimo !== null || estoqueContado !== null || comprarSugestao !== null) {
                dadosParaSalvar.push({
                    nomeProdutoPrincipal: produtoNome,
                    novoEstoqueMinimoProdutoPrincipal: novoEstoqueMinimo,
                    estoqueAtualContagem: estoqueContado,
                    comprarSugestao: comprarSugestao
                });
            }
        });

        if (dadosParaSalvar.length === 0) {
            EtapasScript_exibirFeedbackModalContagem("Nenhum dado foi inserido ou alterado para salvar.", false, 4000);
            return;
        }

        const btnSalvar = modalOverlay.querySelector('#EtapasScript_btnSalvarModalContagem');
        btnSalvar.disabled = true;
        btnSalvar.textContent = 'Salvando...';
        EtapasScript_exibirFeedbackModalContagem("Salvando contagem de estoque...", false, 0);

        try {
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Contagem de Estoque"
                })
            });

            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/salvarContagem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    dadosContagem: dadosParaSalvar
                })
            });

            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar Contagem';
            EtapasScript_fecharModalContagemEstoque();
            window.CotacaoIndividualScript_exibirFeedback(response.message || "Contagem de estoque salva! Atualizando dados...", false, 5000);
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
            
        } catch (error) {
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar Contagem';
            EtapasScript_exibirFeedbackModalContagem("Erro ao salvar: " + error.message, true, 7000);
            console.error("EtapasScript_salvarContagemEstoqueEtapa: Erro:", error);
        }
    }

    function EtapasScript_exibirFeedbackModalContagem(mensagem, isError = false, duracao = 5000) {
        const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
        if (!modalOverlay) return;
        const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalContagem');
        if (feedbackDiv) {
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
            innerDiv.textContent = mensagem;
            feedbackDiv.innerHTML = '';
            feedbackDiv.appendChild(innerDiv);
            if (duracao > 0) {
                setTimeout(() => {
                    if (feedbackDiv.contains(innerDiv)) {
                        feedbackDiv.innerHTML = '';
                    }
                }, duracao);
            }
        }
    }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 2: RETIRAR PRODUTOS DESNECESSÁRIOS (MODAL)
    //----------------------------------------------------------------------------------------------------

    function EtapasScript_identificarProdutosParaRetirada() {
        const produtosParaRetirada = { crit1: [], crit2: [], crit3: [] };
        const produtosPrincipaisAdicionados = { crit1: new Set(), crit2: new Set(), crit3: new Set() };
        if (!window.CotacaoIndividualScript_dadosOriginaisCotacao || window.CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
            return produtosParaRetirada;
        }
        window.CotacaoIndividualScript_dadosOriginaisCotacao.forEach(subProduto => {
            const nomeProdutoPrincipal = subProduto.Produto;
            const estoqueMinProdutoPrincipal = (subProduto.EstoqueMinimoProdutoPrincipal !== null && subProduto.EstoqueMinimoProdutoPrincipal !== undefined && String(subProduto.EstoqueMinimoProdutoPrincipal).trim() !== "") ? parseFloat(String(subProduto.EstoqueMinimoProdutoPrincipal).replace(",", ".")) : null;
            const dadosEstoqueCompra = window.CotacaoIndividualScript_parsearStringEstoqueComprar(subProduto["Estoque Atual"]);
            const estoqueAtualParseado = dadosEstoqueCompra.estoqueAtual;
            const comprarParseado = dadosEstoqueCompra.comprar;
            const rawEstoqueAtualString = subProduto["Estoque Atual"] ? String(subProduto["Estoque Atual"]).trim() : "";
            if (estoqueAtualParseado !== null && !isNaN(estoqueAtualParseado) && estoqueMinProdutoPrincipal !== null && !isNaN(estoqueMinProdutoPrincipal) && estoqueAtualParseado >= estoqueMinProdutoPrincipal) {
                if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal)) {
                    produtosParaRetirada.crit1.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: `Est. Atual (${estoqueAtualParseado}) >= Est. Mín. Prod. (${estoqueMinProdutoPrincipal})`, subProdutoOriginal: subProduto });
                    produtosPrincipaisAdicionados.crit1.add(nomeProdutoPrincipal);
                }
            }
            const celulaEstoqueAtualVazia = rawEstoqueAtualString === "";
            if (celulaEstoqueAtualVazia || (estoqueAtualParseado === null && comprarParseado === null)) {
                if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit2.has(nomeProdutoPrincipal)) {
                    produtosParaRetirada.crit2.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: celulaEstoqueAtualVazia ? "Coluna 'Estoque Atual' vazia" : "Estoque Atual e Comprar são N/A", subProdutoOriginal: subProduto });
                    produtosPrincipaisAdicionados.crit2.add(nomeProdutoPrincipal);
                }
            }
            const estMinPrincipalConsideradoVazioOuNA = (estoqueMinProdutoPrincipal === null || String(subProduto.EstoqueMinimoProdutoPrincipal).trim() === "" || String(subProduto.EstoqueMinimoProdutoPrincipal).toUpperCase() === "N/A");
            if (estMinPrincipalConsideradoVazioOuNA && (celulaEstoqueAtualVazia || (estoqueAtualParseado === null && comprarParseado === null))) {
                if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit2.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit3.has(nomeProdutoPrincipal)) {
                    produtosParaRetirada.crit3.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: "Est.Mín(Prod.Principal) N/A/vazio E (Coluna Est.Atual vazia OU Est.Atual/Comprar N/A)", subProdutoOriginal: subProduto });
                    produtosPrincipaisAdicionados.crit3.add(nomeProdutoPrincipal);
                }
            }
        });
        return produtosParaRetirada;
    }

    function EtapasScript_renderizarAcordeaoRetirarProdutos(modalOverlay, containerId, titulo, produtosPrincipais, idSufixo) {
        const container = modalOverlay.querySelector('#' + containerId);
        if (!container) return;
        container.innerHTML = '';
        const headerId = `header-retirar-${idSufixo}`;
        const contentId = `content-retirar-${idSufixo}`;
        const header = document.createElement('div');
        header.className = 'retirar-accordion-header';
        header.id = headerId;
        header.innerHTML = `<span>${titulo} (${produtosPrincipais.length} Produtos Principais)</span>
                            <svg class="retirar-accordion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>`;
        const content = document.createElement('div');
        content.className = 'retirar-accordion-content';
        content.id = contentId;
        if (produtosPrincipais.length === 0) {
            content.innerHTML = `<div class="p-2 text-sm text-gray-500">Nenhum produto encontrado para este critério.</div>`;
        } else {
            const divSelecionarTodos = document.createElement('div');
            divSelecionarTodos.className = 'flex items-center p-2 border-b border-gray-200 mb-2';
            const checkboxTodos = document.createElement('input');
            checkboxTodos.type = 'checkbox';
            checkboxTodos.id = `select-all-retirar-${idSufixo}`;
            checkboxTodos.className = 'mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
            checkboxTodos.addEventListener('change', function() {
                content.querySelectorAll('.checkbox-retirar-item-principal').forEach(cb => cb.checked = this.checked);
            });
            const labelTodos = document.createElement('label');
            labelTodos.htmlFor = `select-all-retirar-${idSufixo}`;
            labelTodos.textContent = 'Selecionar Todos os Produtos Principais neste Grupo';
            labelTodos.className = 'font-medium text-sm text-gray-700';
            divSelecionarTodos.appendChild(checkboxTodos);
            divSelecionarTodos.appendChild(labelTodos);
            content.appendChild(divSelecionarTodos);
            produtosPrincipais.forEach((produtoPrincipalInfo) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'retirar-subproduto-item py-1';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'checkbox-retirar-item-principal';
                checkbox.dataset.produtoPrincipal = produtoPrincipalInfo.nomeProdutoPrincipal;
                const label = document.createElement('label');
                label.textContent = `${produtoPrincipalInfo.nomeProdutoPrincipal} - Motivo: ${produtoPrincipalInfo.motivo}`;
                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                content.appendChild(itemDiv);
            });
        }
        container.appendChild(header);
        container.appendChild(content);
        header.addEventListener('click', () => {
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
            const icon = header.querySelector('.retirar-accordion-icon');
            if (icon) {
                icon.style.transform = header.classList.contains('expanded') ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        });
    }

    function EtapasScript_renderizarConteudoModalRetirarProdutos(modalOverlay) {
        console.log("EtapasScript: Renderizando conteúdo para o modal de Retirar Produtos.");
        const { crit1, crit2, crit3 } = EtapasScript_identificarProdutosParaRetirada();
        EtapasScript_renderizarAcordeaoRetirarProdutos(modalOverlay, 'EtapasScript_acordeaoContainerCrit1_Modal', "Quantidade maior que o necessário.", crit1, "crit1_modal");
        EtapasScript_renderizarAcordeaoRetirarProdutos(modalOverlay, 'EtapasScript_acordeaoContainerCrit2_Modal', "Não foi marcado para comprar.", crit2, "crit2_modal");
        EtapasScript_renderizarAcordeaoRetirarProdutos(modalOverlay, 'EtapasScript_acordeaoContainerCrit3_Modal', "Produtos inativos ou sem dados.", crit3, "crit3_modal");
    }

    function EtapasScript_ativarModoRetirarProdutos() {
        console.log("EtapasScript: Ativando modo Retirar Produtos (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'retirar_produtos';

        if (window.CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
            window.CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados.", true, 5000);
            CotacaoIndividualScript_modoEtapaAtual = null;
            return;
        }
        
        const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
        if (!modalOverlay) {
            console.error("Modal de Retirar Produtos não encontrado.");
            return;
        }

        EtapasScript_renderizarConteudoModalRetirarProdutos(modalOverlay);
        modalOverlay.classList.add('active');

        const btnConfirmar = modalOverlay.querySelector('#EtapasScript_btnConfirmarRemocaoModal');
        const btnCancelar = modalOverlay.querySelector('#EtapasScript_btnCancelarModalRetirarProdutos');
        const btnFechar = modalOverlay.querySelector('#EtapasScript_btnFecharModalRetirarProdutos');

        btnConfirmar.replaceWith(btnConfirmar.cloneNode(true));
        btnCancelar.replaceWith(btnCancelar.cloneNode(true));
        btnFechar.replaceWith(btnFechar.cloneNode(true));

        modalOverlay.querySelector('#EtapasScript_btnConfirmarRemocaoModal').addEventListener('click', EtapasScript_manipularExclusaoProdutosRetirar);
        modalOverlay.querySelector('#EtapasScript_btnCancelarModalRetirarProdutos').addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
        modalOverlay.querySelector('#EtapasScript_btnFecharModalRetirarProdutos').addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
    }
    
    function EtapasScript_fecharModalRetirarProdutos() {
        console.log("EtapasScript: Fechando modal de Retirar Produtos.");
        const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
            const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalRetirarProdutos');
            if(feedbackDiv) feedbackDiv.innerHTML = '';
        }
        CotacaoIndividualScript_modoEtapaAtual = null;
    }

    function EtapasScript_exibirFeedbackModalRetirarProdutos(mensagem, isError = false, duracao = 5000) {
        const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
        if (!modalOverlay) return;
        const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalRetirarProdutos');
        if (feedbackDiv) {
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
            innerDiv.textContent = mensagem;
            feedbackDiv.innerHTML = '';
            feedbackDiv.appendChild(innerDiv);
            if (duracao > 0) {
                setTimeout(() => {
                    if (feedbackDiv.contains(innerDiv)) {
                        feedbackDiv.innerHTML = '';
                    }
                }, duracao);
            }
        }
    }

    async function EtapasScript_manipularExclusaoProdutosRetirar() {
        const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
        const produtosPrincipaisParaExcluir = [];
        modalOverlay.querySelectorAll('.checkbox-retirar-item-principal:checked').forEach(cb => {
            if (!produtosPrincipaisParaExcluir.includes(cb.dataset.produtoPrincipal)) {
                produtosPrincipaisParaExcluir.push(cb.dataset.produtoPrincipal);
            }
        });

        if (produtosPrincipaisParaExcluir.length === 0) {
            EtapasScript_exibirFeedbackModalRetirarProdutos("Nenhum produto principal selecionado.", true, 4000);
            return;
        }

        const btnConfirmar = modalOverlay.querySelector('#EtapasScript_btnConfirmarRemocaoModal');
        btnConfirmar.disabled = true;
        btnConfirmar.textContent = 'Excluindo...';
        EtapasScript_exibirFeedbackModalRetirarProdutos(`Excluindo ${produtosPrincipaisParaExcluir.length} produto(s)...`, false, 0);

        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/retirarProdutos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    nomesProdutosPrincipaisParaExcluir: produtosPrincipaisParaExcluir
                })
            });
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Remoção';
            EtapasScript_fecharModalRetirarProdutos();
            window.CotacaoIndividualScript_exibirFeedback(response.message || "Produtos retirados!", false, 5000);
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
        } catch (error) {
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Remoção';
            EtapasScript_exibirFeedbackModalRetirarProdutos("Erro ao excluir: " + error.message, true, 7000);
        }
    }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 3: ENVIAR PARA FORNECEDORES (Sem alteração)
    //----------------------------------------------------------------------------------------------------
    async function EtapasScript_iniciarEnvioParaFornecedores() {
        // ... (lógica de API inalterada) ...
    }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 4: REALIZAR COTAÇÃO (Sem alteração)
    //----------------------------------------------------------------------------------------------------
    function EtapasScript_identificarSubprodutosSemPreco() { /* ... */ }
    function EtapasScript_renderizarListaSubprodutosSemPreco(subprodutos) { /* ... */ }
    function EtapasScript_desativarModoRealizarCotacao() { /* ... */ }
    function EtapasScript_iniciarEdicao() { /* ... */ }
    async function EtapasScript_ativarModoRealizarCotacao() { /* ... */ }
    async function EtapasScript_manipularExclusaoSubprodutosSemPreco() { /* ... */ }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 5: DEFINIR EMPRESA (MODAL)
    //----------------------------------------------------------------------------------------------------
    
    function EtapasScript_formatarMoeda(numero) {
        if (typeof numero !== 'number') {
            numero = parseFloat(numero) || 0;
        }
        return `R$ ${numero.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    /**
     * Ponto de entrada da Etapa 5 (Modal). Chama a API Node.js.
     */
    async function EtapasScript_ativarModoDefinirEmpresa() {
        console.log("EtapasScript: Ativando modo Definir Empresa (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'definir_empresa';

        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) {
            console.error("EtapasScript: Overlay do modal da Etapa 5 não encontrado.");
            window.CotacaoIndividualScript_exibirFeedback("Erro crítico: Componente do modal não encontrado.", true, 0);
            return;
        }
        
        modalOverlay.classList.add('active'); 
        EtapasScript_exibirFeedbackModalDefinirEmpresa("Carregando dados para faturamento...", false, 0);

        try {
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Definindo Empresa para Faturamento"
                })
            });

            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/dadosFaturamento', {
                method: 'GET'
            });

            EtapasScript_empresasParaFaturamento = response.empresas || [];
            EtapasScript_pedidosMinimosFornecedores = response.pedidosMinimos || {};

            const itensParaComprar = window.CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => {
                const comprarValor = parseFloat(String(item['Comprar'] || '0').replace(',', '.'));
                return comprarValor > 0;
            });
            
            const dadosAgrupadosPorFornecedor = EtapasScript_agruparPorChave(itensParaComprar, 'Fornecedor');
            
            EtapasScript_renderizarTabelaModoFaturamento(modalOverlay, dadosAgrupadosPorFornecedor, 'EtapasScript_controlsContainer_Modal', 'EtapasScript_tabelaContainer_Modal');
            
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Selecione a empresa para faturamento de cada item.", false, 8000);

        } catch (err) {
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Erro ao carregar dados: " + err.message, true, 5000);
            setTimeout(EtapasScript_fecharModalDefinirEmpresa, 3000);
        }

        // Configura os botões do modal
        modalOverlay.querySelector('#EtapasScript_btnFecharModalDefinirEmpresa').addEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
        modalOverlay.querySelector('#EtapasScript_btnConcluirModalDefinirEmpresa').addEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
        modalOverlay.querySelector('#EtapasScript_btnSalvarFaturamento').addEventListener('click', EtapasScript_salvarFaturamentoEmLote);
    }
    
    function EtapasScript_agruparPorChave(array, chave) {
        return array.reduce((resultado, item) => {
            (resultado[item[chave]] = resultado[item[chave]] || []).push(item);
            return resultado;
        }, {});
    }
    
    function EtapasScript_exibirFeedbackModalDefinirEmpresa(mensagem, isError = false, duracao = 5000) {
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) return;
        const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalDefinirEmpresa');
        if (feedbackDiv) {
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
            innerDiv.textContent = mensagem;
            feedbackDiv.innerHTML = '';
            feedbackDiv.appendChild(innerDiv);
            if (duracao > 0) {
                setTimeout(() => {
                    if (feedbackDiv.contains(innerDiv)) {
                        feedbackDiv.innerHTML = '';
                    }
                }, duracao);
            }
        }
    }
    
    function EtapasScript_fecharModalDefinirEmpresa() {
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
            const controlsContainer = modalOverlay.querySelector('#EtapasScript_controlsContainer_Modal');
            const tableContainer = modalOverlay.querySelector('#EtapasScript_tabelaContainer_Modal');
            const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalDefinirEmpresa');
            if(controlsContainer) controlsContainer.innerHTML = '';
            if(tableContainer) tableContainer.innerHTML = '';
            if(feedbackDiv) feedbackDiv.innerHTML = '';
        }
        CotacaoIndividualScript_modoEtapaAtual = null;
    }

    function EtapasScript_renderizarTabelaModoFaturamento(modalOverlay, dadosAgrupados, controlsContainerId, tableContainerId) {
        const controlsContainer = modalOverlay.querySelector('#' + controlsContainerId);
        const tableContainer = modalOverlay.querySelector('#' + tableContainerId);
        if (!controlsContainer || !tableContainer) {
            console.error("Containers do modal para a Etapa 5 não encontrados.");
            return;
        }
        controlsContainer.innerHTML = '';
        tableContainer.innerHTML = '';

        const globalDashboard = document.createElement('div');
        globalDashboard.id = 'etapa5-global-dashboard-modal';
        globalDashboard.style.cssText = 'border: 1px solid #e2e8f0; padding: 0.5rem 1rem; border-radius: 0.375rem; min-width: 300px; float: right;';
        controlsContainer.appendChild(globalDashboard);

        const tabela = document.createElement('table');
        tabela.className = 'sticky-header-table';
        const thead = tabela.createTHead();
        const tbody = tabela.createTBody();
        tableContainer.appendChild(tabela);

        const cabecalhosVisiveis = EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO;
        const trHeader = thead.insertRow();
        cabecalhosVisiveis.forEach(texto => {
            const th = document.createElement('th');
            th.textContent = texto;
            trHeader.appendChild(th);
        });

        for (const fornecedor in dadosAgrupados) {
            const subProdutos = dadosAgrupados[fornecedor];
            const fornecedorClass = `for-modal-${fornecedor.replace(/[^a-zA-Z0-9]/g, '')}`;
            const fornecedorRow = tbody.insertRow();
            fornecedorRow.className = 'categoria-accordion-header-row';
            fornecedorRow.dataset.targetClass = fornecedorClass;
            const fornecedorCell = fornecedorRow.insertCell();
            fornecedorCell.colSpan = cabecalhosVisiveis.length;
            
            const selectMassa = document.createElement('select');
            selectMassa.className = 'aplicar-massa-empresa';
            selectMassa.style.cssText = "padding: 0.25rem 0.5rem; border: 1px solid #9ca3af; border-radius: 0.375rem; font-size: 0.875rem;";
            selectMassa.innerHTML = `<option value="">Aplicar a todos...</option>` + EtapasScript_empresasParaFaturamento.map(e => `<option value="${e}">${e}</option>`).join('');
            selectMassa.onchange = (e) => { 
                e.stopPropagation(); 
                EtapasScript_aplicarEmpresaParaFornecedor(fornecedor, e.target.value); 
            };
            const headerContainer = document.createElement('div');
            headerContainer.style.cssText = 'display: flex; justify-content: space-between; width: 100%; align-items: center;';
            headerContainer.innerHTML = `
                <div style="display: flex; align-items: center; flex-grow: 1;">
                    <svg class="categoria-accordion-icon" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                    <span style="margin-left: 8px;">Fornecedor: <strong>${fornecedor}</strong></span>
                </div>
                <div id="total-header-${fornecedorClass}"></div>`;
            const selectContainer = document.createElement('div');
            selectContainer.style.marginLeft = '20px';
            selectContainer.appendChild(selectMassa);
            headerContainer.querySelector(`#total-header-${fornecedorClass}`).before(selectContainer);
            fornecedorCell.appendChild(headerContainer);

            const dashboardRow = tbody.insertRow();
            dashboardRow.className = `etapa5-content-row ${fornecedorClass} hidden`;
            const dashboardCell = dashboardRow.insertCell();
            dashboardCell.colSpan = cabecalhosVisiveis.length;
            dashboardCell.style.cssText = 'padding: 8px 25px; background-color: #f0f9ff;';
            dashboardCell.innerHTML = `<div class="mini-dashboard" data-fornecedor="${fornecedor}"></div>`;

            subProdutos.forEach(subProduto => {
                const subRow = tbody.insertRow();
                subRow.className = `sub-produto-row etapa5-content-row ${fornecedorClass} hidden`;
                subRow.dataset.produto = subProduto['Produto'];
                subRow.dataset.fornecedor = subProduto['Fornecedor'];
                subRow.dataset.subprodutoOriginalPersistido = subProduto['_subProdutoOriginalPersistido'];
                cabecalhosVisiveis.forEach(cabecalho => {
                    const td = subRow.insertCell();
                    td.dataset.coluna = cabecalho;
                    const classeCor = window.CotacaoIndividualScript_getClasseCorColuna(cabecalho);
                    if (classeCor) td.classList.add(classeCor);
                    if (cabecalho === "Empresa Faturada") {
                        td.classList.add('editable-select-cell');
                        const select = document.createElement('select');
                        select.className = 'inline-edit-input';
                        select.style.cssText = "width: 100%; padding: 0.25rem; border: 1px solid #9ca3af; border-radius: 0.375rem;";
                        select.innerHTML = `<option value="">Selecione...</option>` + EtapasScript_empresasParaFaturamento.map(e => 
                            `<option value="${e}" ${subProduto[cabecalho] === e ? 'selected' : ''}>${e}</option>`
                        ).join('');
                        select.addEventListener('change', () => {
                            EtapasScript_atualizarDashboardFornecedor(fornecedor);
                            EtapasScript_atualizarDashboardGlobal();
                        });
                        td.appendChild(select);
                    } else {
                        let valor = subProduto[cabecalho];
                        let fmt;
                        if (typeof valor === 'number') {
                            const fractionDigits = { 'Preço por Fator': 4, 'Preço': 2, 'Comprar': 2, 'Valor Total': 2 };
                            fmt = valor.toLocaleString('pt-BR', { minimumFractionDigits: fractionDigits[cabecalho] || 2, maximumFractionDigits: fractionDigits[cabecalho] || 2 });
                        } else {
                            fmt = valor == null ? "" : String(valor);
                        }
                        td.textContent = fmt;
                    }
                });
            });
            fornecedorRow.addEventListener('click', function() {
                this.classList.toggle('expanded');
                const isExpandedNow = this.classList.contains('expanded');
                this.closest('tbody').querySelectorAll(`tr.${this.dataset.targetClass}`).forEach(r => r.classList.toggle('hidden', !isExpandedNow));
                this.querySelector('.categoria-accordion-icon').style.transform = isExpandedNow ? 'rotate(90deg)' : 'rotate(0deg)';
                if (isExpandedNow) EtapasScript_atualizarDashboardFornecedor(fornecedor);
            });
        }
        EtapasScript_atualizarDashboardGlobal();
        tbody.querySelectorAll(".categoria-accordion-header-row").forEach(h => h.click());
    }
    
    function EtapasScript_aplicarEmpresaParaFornecedor(fornecedor, empresa) {
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) return;
        const linhasDoFornecedor = modalOverlay.querySelectorAll(`tr[data-fornecedor="${fornecedor}"].sub-produto-row`);
        linhasDoFornecedor.forEach(row => {
            const selectCell = row.querySelector('td[data-coluna="Empresa Faturada"] select');
            if (selectCell) {
                selectCell.value = empresa;
            }
        });
        EtapasScript_atualizarDashboardFornecedor(fornecedor);
        EtapasScript_atualizarDashboardGlobal();
    }
    
    function EtapasScript_atualizarDashboardFornecedor(fornecedor) {
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) return;
        const fornecedorClass = `for-modal-${fornecedor.replace(/[^a-zA-Z0-9]/g, '')}`;
        const dashboardDiv = modalOverlay.querySelector(`.mini-dashboard[data-fornecedor="${fornecedor}"]`);
        const totalHeaderDiv = modalOverlay.querySelector(`#total-header-${fornecedorClass}`);
        const fornecedorRow = modalOverlay.querySelector(`#fornecedor-row-${fornecedorClass}`);
        if (!dashboardDiv || !totalHeaderDiv || !fornecedorRow) return;
        const totaisPorEmpresa = {};
        let valorTotalFornecedor = 0;
        const linhasFornecedor = modalOverlay.querySelectorAll(`tr[data-fornecedor="${fornecedor}"].sub-produto-row`);
        linhasFornecedor.forEach(row => {
            const empresaCell = row.querySelector('td[data-coluna="Empresa Faturada"]');
            const valorTotalCell = row.querySelector('td[data-coluna="Valor Total"]');
            if (!empresaCell || !valorTotalCell) return;
            const select = empresaCell.querySelector('select');
            const empresa = (select ? select.value : (empresaCell.textContent || '').trim()) || 'Não Definido';
            const valor = parseFloat(valorTotalCell.textContent.replace(/\./g, '').replace(',', '.')) || 0;
            if (!totaisPorEmpresa[empresa]) totaisPorEmpresa[empresa] = 0;
            totaisPorEmpresa[empresa] += valor;
            valorTotalFornecedor += valor;
        });
        const pedidoMinimo = EtapasScript_pedidosMinimosFornecedores[String(fornecedor).trim()] || 0;
        totalHeaderDiv.innerHTML = `
            <span>Total: <strong>${EtapasScript_formatarMoeda(valorTotalFornecedor)}</strong></span>
            ${pedidoMinimo > 0 ? `<span style="margin-left: 15px;">(Mínimo: ${EtapasScript_formatarMoeda(pedidoMinimo)})</span>` : ''}`;
        let dashboardHTML = '<strong>Totais por Empresa:</strong> ';
        let todosAtingiramMinimo = true;
        if (Object.keys(totaisPorEmpresa).length === 0 || (Object.keys(totaisPorEmpresa).length === 1 && totaisPorEmpresa['Não Definido'])) {
            dashboardHTML += '<span style="margin-left: 10px;">Nenhuma empresa definida.</span>';
            if (pedidoMinimo > 0) todosAtingiramMinimo = false;
        } else {
            for (const empresa in totaisPorEmpresa) {
                if (empresa === 'Não Definido') continue;
                const totalEmpresa = totaisPorEmpresa[empresa];
                const atingiuMinimoEmpresa = totalEmpresa >= pedidoMinimo;
                if (!atingiuMinimoEmpresa && pedidoMinimo > 0) {
                    todosAtingiramMinimo = false;
                    dashboardHTML += `<span style="margin-left: 15px; background-color: #fef2f2; padding: 2px 6px; border-radius: 4px; color: #b91c1c; font-weight: bold; border: 1px solid #fecaca;">
                                          ${empresa}: ${EtapasScript_formatarMoeda(totalEmpresa)} (Mínimo não atingido!)
                                      </span>`;
                } else {
                    dashboardHTML += `<span style="margin-left: 15px; background-color: #e0e7ff; padding: 2px 6px; border-radius: 4px;">
                                          ${empresa}: ${EtapasScript_formatarMoeda(totalEmpresa)}
                                      </span>`;
                }
            }
        }
        dashboardDiv.innerHTML = dashboardHTML;
        fornecedorRow.style.backgroundColor = (!todosAtingiramMinimo && pedidoMinimo > 0) ? '#fff7ed' : 'transparent';
        fornecedorRow.style.borderLeft = (!todosAtingiramMinimo && pedidoMinimo > 0) ? '4px solid #f97316' : 'none';
    }
    
    function EtapasScript_atualizarDashboardGlobal() {
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) return;
        const dashboardContainer = modalOverlay.querySelector('#etapa5-global-dashboard-modal');
        if (!dashboardContainer) return;
        const totaisGlobais = {};
        let grandeTotal = 0;
        const todasLinhasDeProduto = modalOverlay.querySelectorAll('tbody .sub-produto-row');
        todasLinhasDeProduto.forEach(row => {
            if (row.offsetParent === null || !row.closest('.etapa5-content-row')) return;
            const empresaCell = row.querySelector('td[data-coluna="Empresa Faturada"]');
            const valorTotalCell = row.querySelector('td[data-coluna="Valor Total"]');
            if (empresaCell && valorTotalCell) {
                const select = empresaCell.querySelector('select');
                const empresa = (select ? select.value : (empresaCell.textContent || '').trim()) || 'Não Definido';
                const valor = parseFloat(valorTotalCell.textContent.replace(/\./g, '').replace(',', '.')) || 0;
                if (!totaisGlobais[empresa]) totaisGlobais[empresa] = 0;
                totaisGlobais[empresa] += valor;
                grandeTotal += valor;
            }
        });
        let dashboardHTML = '<div class="global-dashboard-container">';
        dashboardHTML += '<h4 class="dashboard-title">Totais Gerais por Empresa</h4>';
        dashboardHTML += '<div class="dashboard-items-container">';
        if (Object.keys(totaisGlobais).length === 0) {
            dashboardHTML += '<div class="dashboard-empty-state">Nenhum item a ser faturado.</div>';
        } else {
            for (const empresa in totaisGlobais) {
                dashboardHTML += `<div class="global-total-item">
                                      <span>${empresa}:</span>
                                      <strong>${EtapasScript_formatarMoeda(totaisGlobais[empresa])}</strong>
                                  </div>`;
            }
        }
        dashboardHTML += '</div>';
        if (grandeTotal > 0) {
            dashboardHTML += `<div class="dashboard-grand-total">
                                <span>Total Geral dos Pedidos:</span>
                                <strong>${EtapasScript_formatarMoeda(grandeTotal)}</strong>
                              </div>`;
        }
        dashboardHTML += '</div>';
        dashboardContainer.innerHTML = dashboardHTML;
    }

    async function EtapasScript_salvarFaturamentoEmLote() {
        const alteracoes = [];
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) return;
        const todasLinhasDoModal = modalOverlay.querySelectorAll('.sub-produto-row');
        todasLinhasDoModal.forEach(row => {
            const identificadores = {
                Produto: row.dataset.produto,
                SubProdutoChave: row.dataset.subprodutoOriginalPersistido,
                Fornecedor: row.dataset.fornecedor
            };
            const itemOriginal = window.CotacaoIndividualScript_dadosOriginaisCotacao.find(item => 
                item.Produto === identificadores.Produto &&
                item._subProdutoOriginalPersistido === identificadores.SubProdutoChave &&
                item.Fornecedor === identificadores.Fornecedor
            );
            const selectEmpresa = row.querySelector('td[data-coluna="Empresa Faturada"] select');
            if (selectEmpresa && itemOriginal) {
                const novaEmpresa = selectEmpresa.value;
                const empresaOriginal = itemOriginal["Empresa Faturada"] || "";
                if (novaEmpresa !== empresaOriginal) {
                    alteracoes.push({ ...identificadores, "Empresa Faturada": novaEmpresa });
                }
            }
        });

        if (alteracoes.length === 0) {
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Nenhuma alteração foi feita para salvar.", false, 4000);
            return;
        }

        const btnSalvar = modalOverlay.querySelector('#EtapasScript_btnSalvarFaturamento');
        btnSalvar.disabled = true;
        btnSalvar.textContent = 'Salvando...';
        EtapasScript_exibirFeedbackModalDefinirEmpresa(`Salvando ${alteracoes.length} alteraçõe(s)...`, false, 0);

        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/salvarFaturamento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    alteracoes: alteracoes
                })
            });

            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar e Fechar';
            EtapasScript_fecharModalDefinirEmpresa();
            window.CotacaoIndividualScript_exibirFeedback(response.message || "Faturamento salvo!", false, 5000);
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
        } catch (error) {
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar e Fechar';
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Erro ao salvar: " + error.message, true, 7000);
        }
    }


    //----------------------------------------------------------------------------------------------------
    // ETAPA 6: DEFINIR CONDIÇÕES DE PAGAMENTO (MODAL)
    //----------------------------------------------------------------------------------------------------

    function EtapasScript_exibirFeedbackModalCondicoes(mensagem, isError = false, duracao = 5000) {
        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        if (!modalOverlay) return;
        const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalCondicoes');
        if (feedbackDiv) { 
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
            innerDiv.textContent = mensagem;
            feedbackDiv.innerHTML = '';
            feedbackDiv.appendChild(innerDiv);
            if (duracao > 0) {
                setTimeout(() => {
                    if (feedbackDiv.contains(innerDiv)) {
                        feedbackDiv.innerHTML = '';
                    }
                }, duracao);
            }
        }
    }
    
    function EtapasScript_fecharModalCondicoesPagamento() {
        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        let procederFechamento = true;
        if(modalOverlay) {
            const todosOsInputs = modalOverlay.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pagamento-input');
            if (todosOsInputs.length > 0) {
                const algumVazio = Array.from(todosOsInputs).some(input => input.value.trim() === '');
                if (algumVazio) {
                    procederFechamento = confirm("Atenção: Existem condições de pagamento não preenchidas. Deseja realmente fechar?");
                }
            }
        }
        if (procederFechamento && modalOverlay) {
            modalOverlay.classList.remove('active');
            const feedbackDiv = modalOverlay.querySelector('#EtapasScript_feedbackModalCondicoes');
            if(feedbackDiv) feedbackDiv.innerHTML = '';
        }
        if (procederFechamento) {
            CotacaoIndividualScript_modoEtapaAtual = null;
        }
    }
    
    function EtapasScript_renderizarInterfaceCondicoesPagamento(modalOverlay, itensParaComprar, condicoesFornecedores, pedidosListContainerId) {
        const pedidosListContainer = modalOverlay.querySelector('#' + pedidosListContainerId);
        const template = document.getElementById('etapa6-pedido-item-template');
        if (!pedidosListContainer || !template) {
            console.error("Erro crítico: Elementos do modal Etapa 6 não encontrados.");
            EtapasScript_exibirFeedbackModalCondicoes("Erro de interface. Recarregue a página.", true, 0);
            return;
        }
        pedidosListContainer.innerHTML = '';

        const agrupado = itensParaComprar.reduce((acc, item) => {
            const fornecedor = item['Fornecedor'];
            const empresa = item['Empresa Faturada'];
            const chave = `${fornecedor}__${empresa}`;
            if (!acc[chave]) {
                acc[chave] = { fornecedor, empresa, total: 0, condicaoSalva: item['Condição de Pagamento'] || '' };
            }
            acc[chave].total += (parseFloat(String(item['Preço'] || 0).replace(',', '.')) || 0) * (parseFloat(String(item['Comprar'] || 0).replace(',', '.')) || 0);
            return acc;
        }, {});

        const listaPedidos = Object.values(agrupado);
        if (listaPedidos.length === 0) {
            pedidosListContainer.innerHTML = '<p class="text-gray-500 text-center">Nenhum item a ser pago.</p>';
            return;
        }

        listaPedidos.forEach((pedido, index) => {
            const clone = template.content.cloneNode(true);
            const uniqueId = `etapa6-pedido-modal-${index}`;
            const condicoesSugeridas = condicoesFornecedores[pedido.fornecedor] || 'N/A';
            clone.querySelector('.fornecedor-nome').textContent = pedido.fornecedor;
            clone.querySelector('.empresa-nome').textContent = pedido.empresa;
            clone.querySelector('.valor-total').textContent = EtapasScript_formatarMoeda(pedido.total);
            clone.querySelector('.condicoes-sugeridas').textContent = condicoesSugeridas.replace(/[,;]/g, ' / ');
            const inputCond = clone.querySelector('input[type="text"]');
            inputCond.id = `cond-pagto-${uniqueId}`;
            inputCond.value = pedido.condicaoSalva;
            const itemDiv = clone.querySelector('.etapa6-pedido-item');
            itemDiv.dataset.fornecedor = pedido.fornecedor;
            itemDiv.dataset.empresa = pedido.empresa;
            itemDiv.dataset.total = pedido.total;
            inputCond.addEventListener('input', () => {
                clearTimeout(EtapasScript_debounceTimer);
                EtapasScript_debounceTimer = setTimeout(EtapasScript_atualizarFluxoCaixaGeral, 300);
            });
            pedidosListContainer.appendChild(clone);
        });
        EtapasScript_atualizarFluxoCaixaGeral();
    }

    function EtapasScript_atualizarFluxoCaixaGeral() {
        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        if (!modalOverlay || !modalOverlay.classList.contains('active')) return;
        const todosOsPedidos = modalOverlay.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pedido-item');
        const tbody = modalOverlay.querySelector('#etapa6-fluxo-preview-tbody-modal');
        if (!tbody) return;
        const totaisDiarios = {};
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        todosOsPedidos.forEach(item => {
            const valorTotal = parseFloat(item.dataset.total);
            const condicao = item.querySelector('input[type="text"]').value;
            if (!condicao || isNaN(valorTotal) || valorTotal <= 0) return;
            const prazos = String(condicao).split(/[/,; ]+/).map(p => parseInt(p.trim(), 10)).filter(p => !isNaN(p) && p >= 0);
            if (prazos.length === 0) return;
            const valorParcela = valorTotal / prazos.length;
            prazos.forEach(dias => {
                const dataVencimento = new Date(hoje.getTime());
                dataVencimento.setDate(hoje.getDate() + dias);
                const chaveData = dataVencimento.toISOString().split('T')[0];
                totaisDiarios[chaveData] = (totaisDiarios[chaveData] || 0) + valorParcela;
            });
        });
        const chavesOrdenadas = Object.keys(totaisDiarios).sort();
        tbody.innerHTML = '';
        if (chavesOrdenadas.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500">Nenhuma condição válida.</td></tr>';
            return;
        }
        chavesOrdenadas.forEach(chaveData => {
            const [ano, mes, dia] = chaveData.split('-');
            const dataLabel = `${dia}/${mes}/${ano}`;
            const valorDia = totaisDiarios[chaveData];
            const row = tbody.insertRow();
            row.insertCell().textContent = dataLabel;
            row.insertCell().textContent = EtapasScript_formatarMoeda(valorDia);
        });
    }

    async function EtapasScript_ativarModoDefinirCondicoesPagamento() {
        console.log("EtapasScript: Ativando modo Definir Condições de Pagamento (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'definir_condicoes_pagamento';
        const itensParaComprar = window.CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => 
            (parseFloat(String(item['Comprar'] || '0').replace(',', '.')) || 0) > 0
        );
        const itemSemEmpresa = itensParaComprar.find(item => !item['Empresa Faturada']);
        if (itemSemEmpresa) {
            window.CotacaoIndividualScript_exibirFeedback("Erro: Complete a Etapa 5 (Definir Empresa) primeiro.", true, 8000);
            CotacaoIndividualScript_modoEtapaAtual = null;
            return;
        }

        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        if (!modalOverlay) {
            console.error("Modal Etapa 6 não encontrado.");
            return;
        }
        
        modalOverlay.classList.add('active');
        EtapasScript_exibirFeedbackModalCondicoes("Carregando dados...", false, 0);
        modalOverlay.querySelector('#etapa6-pedidos-list-modal').innerHTML = '<p class="text-gray-500 text-center p-4">Carregando...</p>';

        modalOverlay.querySelector('#EtapasScript_btnFecharModalCondicoes').addEventListener('click', EtapasScript_fecharModalCondicoesPagamento);
        modalOverlay.querySelector('#EtapasScript_btnCancelarModalCondicoes').addEventListener('click', EtapasScript_fecharModalCondicoesPagamento);
        modalOverlay.querySelector('#EtapasScript_btnSalvarModalCondicoes').addEventListener('click', EtapasScript_salvarDadosCondicoesPagamento);

        try {
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Definindo Condições de Pagamento"
                })
            });

            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/dadosCondicoes', {
                method: 'GET'
            });

            EtapasScript_renderizarInterfaceCondicoesPagamento(modalOverlay, itensParaComprar, response.condicoes || {}, 'etapa6-pedidos-list-modal');
            EtapasScript_exibirFeedbackModalCondicoes("", false, 1);
        } catch (err) {
            EtapasScript_exibirFeedbackModalCondicoes("Erro ao carregar dados: " + err.message, true, 5000);
            setTimeout(EtapasScript_fecharModalCondicoesPagamento, 3000);
        }
    }

    async function EtapasScript_salvarDadosCondicoesPagamento() {
        console.log("EtapasScript: Salvando condições de pagamento do modal...");
        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        if (!modalOverlay) return;

        const dadosParaSalvar = [];
        let primeiroCampoVazio = null;
        modalOverlay.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pedido-item').forEach(item => {
            const fornecedor = item.dataset.fornecedor;
            const empresa = item.dataset.empresa;
            const condicaoInput = item.querySelector('input[type="text"]');
            const condicao = condicaoInput.value.trim();
            if (condicao === '') {
                if (!primeiroCampoVazio) primeiroCampoVazio = condicaoInput;
            }
            dadosParaSalvar.push({ fornecedor, empresa, condicao });
        });

        if (primeiroCampoVazio) {
            EtapasScript_exibirFeedbackModalCondicoes("Erro: Todas as condições de pagamento devem ser preenchidas.", true, 5000);
            primeiroCampoVazio.focus();
            return;
        }
        if (dadosParaSalvar.length === 0) {
            EtapasScript_exibirFeedbackModalCondicoes("Não há pedidos para salvar.", false, 4000);
            return;
        }

        const btnSalvar = modalOverlay.querySelector('#EtapasScript_btnSalvarModalCondicoes');
        btnSalvar.disabled = true;
        btnSalvar.textContent = "Salvando...";
        EtapasScript_exibirFeedbackModalCondicoes("Salvando condições...", false, 0);

        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/salvarCondicoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    dadosPagamento: dadosParaSalvar
                })
            });

            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar Condições";
            EtapasScript_fecharModalCondicoesPagamento();
            window.CotacaoIndividualScript_exibirFeedback(response.message, false, 6000);
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
        } catch (error) {
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar Condições";
            EtapasScript_exibirFeedbackModalCondicoes("Erro ao salvar: ", D + error.message, true);
        }
    }


    //----------------------------------------------------------------------------------------------------
    // ETAPA 7: IMPRIMIR PEDIDOS
    //----------------------------------------------------------------------------------------------------

    function EtapasScript_abrirPaginaImpressao() {
        console.log("EtapasScript: Solicitando abertura da página de impressão.");
        const idCotacao = window.CotacaoIndividualScript_cotacaoIdAtual;
        if (!idCotacao) {
            window.CotacaoIndividualScript_exibirFeedback("Erro: ID da Cotação não encontrado.", true, 5000);
            return;
        }
        const url = `/view/ImprimirPedidosView?idCotacao=${encodeURIComponent(idCotacao)}`;
        console.log(`Abrindo URL: ${url}`);
        window.open(url, '_blank');
    }
</script>