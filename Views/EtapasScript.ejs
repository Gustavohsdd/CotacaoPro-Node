<script>
    //####################################################################################################
    // MÓDULO: ETAPAS (CLIENT-SIDE) - EtapasScript.ejs
    // Funções relacionadas às etapas da cotação.
    //####################################################################################################

    /**
     * @file EtapasScript.ejs
     * @description Lógica client-side para as funcionalidades do menu "Etapas".
     */

    // Constante de exibição para a Etapa 5
    const EtapasScript_COLUNAS_A_EXIBIR_FATURAMENTO = [
        "SubProduto", "Preço", "Preço por Fator", "Comprar", "Valor Total", "Empresa Faturada"
    ];

    //----------------------------------------------------------------------------------------------------
    // ETAPA 1: CONTAGEM DE ESTOQUE (MODAL)
    //----------------------------------------------------------------------------------------------------

    /**
     * Ponto de entrada para a Etapa 1. Prepara e exibe o modal de Contagem de Estoque.
     */
    function EtapasScript_ativarModoContagemEstoque() {
        console.log("EtapasScript: Ativando modo Contagem de Estoque (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'contagem_estoque';

        if (window.CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
            window.CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
            CotacaoIndividualScript_modoEtapaAtual = null;
            return;
        }

        EtapasScript_renderizarConteudoModalContagem();

        const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
        if (modalOverlay) {
            modalOverlay.classList.add('active');
        }

        const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
        const btnCancelar = document.getElementById('EtapasScript_btnCancelarModalContagem');
        const btnFechar = document.getElementById('EtapasScript_btnFecharModalContagemEstoque');

        // Limpa listeners antigos para segurança
        btnSalvar.replaceWith(btnSalvar.cloneNode(true));
        btnCancelar.replaceWith(btnCancelar.cloneNode(true));
        btnFechar.replaceWith(btnFechar.cloneNode(true));

        // Adiciona os novos event listeners
        document.getElementById('EtapasScript_btnSalvarModalContagem').addEventListener('click', EtapasScript_salvarContagemEstoqueEtapa);
        document.getElementById('EtapasScript_btnCancelarModalContagem').addEventListener('click', EtapasScript_fecharModalContagemEstoque);
        document.getElementById('EtapasScript_btnFecharModalContagemEstoque').addEventListener('click', EtapasScript_fecharModalContagemEstoque);
    }

    /**
     * Fecha o modal de contagem de estoque.
     */
    function EtapasScript_fecharModalContagemEstoque() {
        console.log("EtapasScript: Fechando modal de Contagem de Estoque.");
        const modalOverlay = document.getElementById('EtapasScript_modalContagemEstoqueOverlay');
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
        }
        CotacaoIndividualScript_modoEtapaAtual = null;
        
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalContagem');
        if (feedbackDiv) feedbackDiv.innerHTML = '';
    }

    /**
     * Renderiza o corpo da tabela dentro do modal de contagem de estoque.
     * (Função 100% client-side, sem alteração de lógica)
     */
    function EtapasScript_renderizarConteudoModalContagem() {
        const tbody = document.getElementById('EtapasScript_tbodyModalContagemEstoque');
        if (!tbody) {
            console.error("EtapasScript_renderizarConteudoModalContagem: Tbody do modal não encontrado.");
            return;
        }
        tbody.innerHTML = '';

        const produtosPrincipais = {};
        window.CotacaoIndividualScript_dadosOriginaisCotacao.forEach(item => {
            const nomeProduto = item.Produto;
            if (!produtosPrincipais[nomeProduto]) {
                produtosPrincipais[nomeProduto] = {
                    nome: nomeProduto,
                    estoqueMinimo: (item.EstoqueMinimoProdutoPrincipal !== null && item.EstoqueMinimoProdutoPrincipal !== undefined)
                        ? item.EstoqueMinimoProdutoPrincipal : '',
                    dadosEstoqueCompra: window.CotacaoIndividualScript_parsearStringEstoqueComprar(item["Estoque Atual"])
                };
            }
        });

        const listaProdutos = Object.values(produtosPrincipais).sort((a, b) => a.nome.localeCompare(b.nome));

        if (listaProdutos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center p-4 text-gray-500">Nenhum produto na cotação.</td></tr>';
            return;
        }

        listaProdutos.forEach(produto => {
            const tr = tbody.insertRow();
            tr.dataset.produtoNome = produto.nome;
            const tdProduto = tr.insertCell();
            tdProduto.textContent = produto.nome;
            const tdEstMin = tr.insertCell();
            const inputEstMin = document.createElement('input');
            inputEstMin.type = 'number';
            inputEstMin.className = 'input-contagem input-estoque-min-prod-principal w-full p-2 border border-gray-300 rounded-md';
            inputEstMin.placeholder = 'Ex: 10';
            inputEstMin.value = produto.estoqueMinimo;
            tdEstMin.appendChild(inputEstMin);
            const tdEstContado = tr.insertCell();
            const inputEstContado = document.createElement('input');
            inputEstContado.type = 'number';
            inputEstContado.className = 'input-contagem input-estoque-contado-prod-principal w-full p-2 border border-gray-300 rounded-md';
            inputEstContado.placeholder = 'Ex: 15';
            inputEstContado.value = produto.dadosEstoqueCompra.estoqueAtual !== null ? produto.dadosEstoqueCompra.estoqueAtual : '';
            tdEstContado.appendChild(inputEstContado);
            const tdComprar = tr.insertCell();
            const inputComprar = document.createElement('input');
            inputComprar.type = 'number';
            inputComprar.className = 'input-contagem input-comprar-sugestao-prod-principal w-full p-2 border border-gray-300 rounded-md';
            inputComprar.placeholder = 'Ex: 5';
            inputComprar.value = produto.dadosEstoqueCompra.comprar !== null ? produto.dadosEstoqueCompra.comprar : '';
            tdComprar.appendChild(inputComprar);
        });
    }

    /**
     * ATUALIZADO: Coleta os dados dos inputs do modal e os envia para a API Node.js.
     */
    async function EtapasScript_salvarContagemEstoqueEtapa() {
        console.log("EtapasScript: Coletando dados do modal para salvar.");
        
        const dadosParaSalvar = [];
        document.querySelectorAll('#EtapasScript_tbodyModalContagemEstoque tr').forEach(row => {
            const produtoNome = row.dataset.produtoNome;
            if (!produtoNome) return;

            const inputEstMinElem = row.querySelector('.input-estoque-min-prod-principal');
            const inputEstContadoElem = row.querySelector('.input-estoque-contado-prod-principal');
            const inputComprarSugElem = row.querySelector('.input-comprar-sugestao-prod-principal');

            const novoEstoqueMinimo = (inputEstMinElem && inputEstMinElem.value !== '') ? parseFloat(inputEstMinElem.value.replace(',', '.')) : null;
            const estoqueContado = (inputEstContadoElem && inputEstContadoElem.value !== '') ? parseFloat(inputEstContadoElem.value.replace(',', '.')) : null;
            const comprarSugestao = (inputComprarSugElem && inputComprarSugElem.value !== '') ? parseFloat(inputComprarSugElem.value.replace(',', '.')) : null;

            if (novoEstoqueMinimo !== null || estoqueContado !== null || comprarSugestao !== null) {
                dadosParaSalvar.push({
                    nomeProdutoPrincipal: produtoNome,
                    novoEstoqueMinimoProdutoPrincipal: novoEstoqueMinimo,
                    estoqueAtualContagem: estoqueContado,
                    comprarSugestao: comprarSugestao
                });
            }
        });

        if (dadosParaSalvar.length === 0) {
            EtapasScript_exibirFeedbackModalContagem("Nenhum dado foi inserido ou alterado para salvar.", false, 4000);
            return;
        }

        const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalContagem');
        btnSalvar.disabled = true;
        btnSalvar.textContent = 'Salvando...';
        EtapasScript_exibirFeedbackModalContagem("Salvando contagem de estoque...", false, 0);

        try {
            // 1. Atualiza o status
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Contagem de Estoque"
                })
            });

            // 2. Salva os dados da contagem
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/salvarContagem', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    dadosContagem: dadosParaSalvar
                })
            });

            // 3. Sucesso
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar Contagem';
            EtapasScript_fecharModalContagemEstoque();
            window.CotacaoIndividualScript_exibirFeedback(response.message || "Contagem de estoque salva! Atualizando dados...", false, 5000);
            
            // Recarrega os dados da cotação principal
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
            
        } catch (error) {
            // 4. Falha
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar Contagem';
            EtapasScript_exibirFeedbackModalContagem("Erro ao salvar: " + error.message, true, 7000);
            console.error("EtapasScript_salvarContagemEstoqueEtapa: Erro:", error);
        }
    }

    /**
     * Exibe feedback dentro do modal de Contagem de Estoque.
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_exibirFeedbackModalContagem(mensagem, isError = false, duracao = 5000) {
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalContagem');
        if (feedbackDiv) {
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
            innerDiv.textContent = mensagem;
            feedbackDiv.innerHTML = '';
            feedbackDiv.appendChild(innerDiv);
            
            if (duracao > 0) {
                setTimeout(() => {
                    if (feedbackDiv.contains(innerDiv)) {
                        feedbackDiv.innerHTML = '';
                    }
                }, duracao);
            }
        }
    }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 2: RETIRAR PRODUTOS DESNECESSÁRIOS (MODAL)
    //----------------------------------------------------------------------------------------------------

    /**
     * Identifica produtos para retirada.
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_identificarProdutosParaRetirada() {
        const produtosParaRetirada = { crit1: [], crit2: [], crit3: [] };
        const produtosPrincipaisAdicionados = { crit1: new Set(), crit2: new Set(), crit3: new Set() };

        if (!window.CotacaoIndividualScript_dadosOriginaisCotacao || window.CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
            console.warn("EtapasScript_identificarProdutosParaRetirada: Nenhum dado original da cotação.");
            return produtosParaRetirada;
        }

        window.CotacaoIndividualScript_dadosOriginaisCotacao.forEach(subProduto => {
            const nomeProdutoPrincipal = subProduto.Produto;
            const estoqueMinProdutoPrincipal = (subProduto.EstoqueMinimoProdutoPrincipal !== null && subProduto.EstoqueMinimoProdutoPrincipal !== undefined && String(subProduto.EstoqueMinimoProdutoPrincipal).trim() !== "")
                ? parseFloat(String(subProduto.EstoqueMinimoProdutoPrincipal).replace(",", "."))
                : null;
            const dadosEstoqueCompra = window.CotacaoIndividualScript_parsearStringEstoqueComprar(subProduto["Estoque Atual"]);
            const estoqueAtualParseado = dadosEstoqueCompra.estoqueAtual;
            const comprarParseado = dadosEstoqueCompra.comprar;
            const rawEstoqueAtualString = subProduto["Estoque Atual"] ? String(subProduto["Estoque Atual"]).trim() : "";

            if (estoqueAtualParseado !== null && !isNaN(estoqueAtualParseado) && estoqueMinProdutoPrincipal !== null && !isNaN(estoqueMinProdutoPrincipal) && estoqueAtualParseado >= estoqueMinProdutoPrincipal) {
                if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal)) {
                    produtosParaRetirada.crit1.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: `Est. Atual (${estoqueAtualParseado}) >= Est. Mín. Prod. (${estoqueMinProdutoPrincipal})`, subProdutoOriginal: subProduto });
                    produtosPrincipaisAdicionados.crit1.add(nomeProdutoPrincipal);
                }
            }
            const celulaEstoqueAtualVazia = rawEstoqueAtualString === "";
            if (celulaEstoqueAtualVazia || (estoqueAtualParseado === null && comprarParseado === null)) {
                if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit2.has(nomeProdutoPrincipal)) {
                    produtosParaRetirada.crit2.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: celulaEstoqueAtualVazia ? "Coluna 'Estoque Atual' vazia" : "Estoque Atual e Comprar são N/A", subProdutoOriginal: subProduto });
                    produtosPrincipaisAdicionados.crit2.add(nomeProdutoPrincipal);
                }
            }
            const estMinPrincipalConsideradoVazioOuNA = (estoqueMinProdutoPrincipal === null || String(subProduto.EstoqueMinimoProdutoPrincipal).trim() === "" || String(subProduto.EstoqueMinimoProdutoPrincipal).toUpperCase() === "N/A");
            if (estMinPrincipalConsideradoVazioOuNA && (celulaEstoqueAtualVazia || (estoqueAtualParseado === null && comprarParseado === null))) {
                if (!produtosPrincipaisAdicionados.crit1.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit2.has(nomeProdutoPrincipal) && !produtosPrincipaisAdicionados.crit3.has(nomeProdutoPrincipal)) {
                    produtosParaRetirada.crit3.push({ nomeProdutoPrincipal: nomeProdutoPrincipal, motivo: "Est.Mín(Prod.Principal) N/A/vazio E (Coluna Est.Atual vazia OU Est.Atual/Comprar N/A)", subProdutoOriginal: subProduto });
                    produtosPrincipaisAdicionados.crit3.add(nomeProdutoPrincipal);
                }
            }
        });
        return produtosParaRetirada;
    }

    /**
     * Renderiza o acordeão de retirada de produtos.
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_renderizarAcordeaoRetirarProdutos(containerId, titulo, produtosPrincipais, idSufixo) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        const headerId = `header-retirar-${idSufixo}`;
        const contentId = `content-retirar-${idSufixo}`;

        const header = document.createElement('div');
        header.className = 'retirar-accordion-header';
        header.id = headerId;
        header.innerHTML = `<span>${titulo} (${produtosPrincipais.length} Produtos Principais)</span>
                            <svg class="retirar-accordion-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                            </svg>`;
        const content = document.createElement('div');
        content.className = 'retirar-accordion-content';
        content.id = contentId;

        if (produtosPrincipais.length === 0) {
            content.innerHTML = `<div class="p-2 text-sm text-gray-500">Nenhum produto encontrado para este critério.</div>`;
        } else {
            const divSelecionarTodos = document.createElement('div');
            divSelecionarTodos.className = 'flex items-center p-2 border-b border-gray-200 mb-2';
            const checkboxTodos = document.createElement('input');
            checkboxTodos.type = 'checkbox';
            checkboxTodos.id = `select-all-retirar-${idSufixo}`;
            checkboxTodos.className = 'mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
            checkboxTodos.addEventListener('change', function() {
                content.querySelectorAll('.checkbox-retirar-item-principal').forEach(cb => cb.checked = this.checked);
            });
            const labelTodos = document.createElement('label');
            labelTodos.htmlFor = `select-all-retirar-${idSufixo}`;
            labelTodos.textContent = 'Selecionar Todos os Produtos Principais neste Grupo';
            labelTodos.className = 'font-medium text-sm text-gray-700';
            divSelecionarTodos.appendChild(checkboxTodos);
            divSelecionarTodos.appendChild(labelTodos);
            content.appendChild(divSelecionarTodos);

            produtosPrincipais.forEach((produtoPrincipalInfo) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'retirar-subproduto-item py-1';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'checkbox-retirar-item-principal';
                checkbox.dataset.produtoPrincipal = produtoPrincipalInfo.nomeProdutoPrincipal;
                const label = document.createElement('label');
                label.textContent = `${produtoPrincipalInfo.nomeProdutoPrincipal} - Motivo: ${produtoPrincipalInfo.motivo}`;
                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                content.appendChild(itemDiv);
            });
        }
        container.appendChild(header);
        container.appendChild(content);
        header.addEventListener('click', () => {
            header.classList.toggle('expanded');
            content.classList.toggle('expanded');
            const icon = header.querySelector('.retirar-accordion-icon');
            if (icon) {
                icon.style.transform = header.classList.contains('expanded') ? 'rotate(90deg)' : 'rotate(0deg)';
            }
        });
    }

    /**
     * Renderiza o conteúdo do modal de retirada.
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_renderizarConteudoModalRetirarProdutos() {
        console.log("EtapasScript: Renderizando conteúdo para o modal de Retirar Produtos.");
        const { crit1, crit2, crit3 } = EtapasScript_identificarProdutosParaRetirada();
        EtapasScript_renderizarAcordeaoRetirarProdutos('EtapasScript_acordeaoContainerCrit1_Modal', "Quantidade maior que o necessário.", crit1, "crit1_modal");
        EtapasScript_renderizarAcordeaoRetirarProdutos('EtapasScript_acordeaoContainerCrit2_Modal', "Não foi marcado para comprar.", crit2, "crit2_modal");
        EtapasScript_renderizarAcordeaoRetirarProdutos('EtapasScript_acordeaoContainerCrit3_Modal', "Produtos inativos ou sem dados.", crit3, "crit3_modal");
    }

    /**
     * Ponto de entrada da Etapa 2 (Modal).
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_ativarModoRetirarProdutos() {
        console.log("EtapasScript: Ativando modo Retirar Produtos (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'retirar_produtos';

        if (window.CotacaoIndividualScript_dadosOriginaisCotacao.length === 0) {
            window.CotacaoIndividualScript_exibirFeedback("Dados da cotação ainda não carregados. Tente novamente.", true, 5000);
            CotacaoIndividualScript_modoEtapaAtual = null;
            return;
        }

        EtapasScript_renderizarConteudoModalRetirarProdutos();

        const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
        if (modalOverlay) {
            modalOverlay.classList.add('active');
        }

        const btnConfirmar = document.getElementById('EtapasScript_btnConfirmarRemocaoModal');
        const btnCancelar = document.getElementById('EtapasScript_btnCancelarModalRetirarProdutos');
        const btnFechar = document.getElementById('EtapasScript_btnFecharModalRetirarProdutos');

        btnConfirmar.replaceWith(btnConfirmar.cloneNode(true));
        btnCancelar.replaceWith(btnCancelar.cloneNode(true));
        btnFechar.replaceWith(btnFechar.cloneNode(true));

        document.getElementById('EtapasScript_btnConfirmarRemocaoModal').addEventListener('click', EtapasScript_manipularExclusaoProdutosRetirar);
        document.getElementById('EtapasScript_btnCancelarModalRetirarProdutos').addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
        document.getElementById('EtapasScript_btnFecharModalRetirarProdutos').addEventListener('click', EtapasScript_fecharModalRetirarProdutos);
    }
    
    /**
     * Fecha o modal de Retirar Produtos.
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_fecharModalRetirarProdutos() {
        console.log("EtapasScript: Fechando modal de Retirar Produtos.");
        const modalOverlay = document.getElementById('EtapasScript_modalRetirarProdutosOverlay');
        if (modalOverlay) {
            modalOverlay.classList.remove('active');
        }
        CotacaoIndividualScript_modoEtapaAtual = null;
        
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
        if(feedbackDiv) feedbackDiv.innerHTML = '';
    }

    /**
     * Exibe feedback dentro do modal de Retirar Produtos.
     * (Função 100% client-side, sem alteração)
     */
    function EtapasScript_exibirFeedbackModalRetirarProdutos(mensagem, isError = false, duracao = 5000) {
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalRetirarProdutos');
        if (feedbackDiv) {
            const innerDiv = document.createElement('div');
            innerDiv.className = `p-3 rounded-md text-sm ${isError ? 'bg-red-100 text-red-700 border border-red-300' : 'bg-green-100 text-green-700 border border-green-300'}`;
            innerDiv.textContent = mensagem;
            feedbackDiv.innerHTML = '';
            feedbackDiv.appendChild(innerDiv);
            
            if (duracao > 0) {
                setTimeout(() => {
                    if (feedbackDiv.contains(innerDiv)) {
                        feedbackDiv.innerHTML = '';
                    }
                }, duracao);
            }
        }
    }

    /**
     * ATUALIZADO: Coleta os produtos selecionados no modal e chama a API Node.js.
     */
    async function EtapasScript_manipularExclusaoProdutosRetirar() {
        const produtosPrincipaisParaExcluir = [];
        document.querySelectorAll('#EtapasScript_modalRetirarProdutosOverlay .checkbox-retirar-item-principal:checked').forEach(cb => {
            if (!produtosPrincipaisParaExcluir.includes(cb.dataset.produtoPrincipal)) {
                produtosPrincipaisParaExcluir.push(cb.dataset.produtoPrincipal);
            }
        });

        if (produtosPrincipaisParaExcluir.length === 0) {
            EtapasScript_exibirFeedbackModalRetirarProdutos("Nenhum produto principal selecionado para exclusão.", true, 4000);
            return;
        }

        const btnConfirmar = document.getElementById('EtapasScript_btnConfirmarRemocaoModal');
        btnConfirmar.disabled = true;
        btnConfirmar.textContent = 'Excluindo...';
        EtapasScript_exibirFeedbackModalRetirarProdutos(`Excluindo ${produtosPrincipaisParaExcluir.length} produto(s)...`, false, 0);

        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/retirarProdutos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    nomesProdutosPrincipaisParaExcluir: produtosPrincipaisParaExcluir
                })
            });

            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Remoção';
            EtapasScript_fecharModalRetirarProdutos();
            window.CotacaoIndividualScript_exibirFeedback(response.message || "Produtos retirados com sucesso!", false, 5000);
            
            // Recarrega os dados da cotação
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
            
        } catch (error) {
            btnConfirmar.disabled = false;
            btnConfirmar.textContent = 'Confirmar Remoção';
            EtapasScript_exibirFeedbackModalRetirarProdutos("Erro ao excluir produtos: " + error.message, true, 7000);
        }
    }


    //----------------------------------------------------------------------------------------------------
    // ETAPA 3: ENVIAR PARA FORNECEDORES
    //----------------------------------------------------------------------------------------------------

    /**
     * ATUALIZADO: Chama a API Node.js para atualizar status e gerar links.
     */
    async function EtapasScript_iniciarEnvioParaFornecedores() {
        console.log("EtapasScript: Iniciando envio para fornecedores.");
        window.CotacaoIndividualScript_restaurarVisualizacaoPadrao(true);
        CotacaoIndividualScript_modoEtapaAtual = null;

        if (!window.CotacaoIndividualScript_cotacaoIdAtual) {
            window.CotacaoIndividualScript_exibirFeedback("ID da Cotação não definido.", true, 5000);
            return;
        }
        window.CotacaoIndividualScript_mostrarLoadingOverlay(true, "Atualizando status e gerando links...");

        try {
            // 1. Atualiza o status
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Aguardando Preços"
                })
            });
            window.CotacaoIndividualScript_exibirFeedback("Status atualizado para 'Aguardando Preços'.", false, 0);

            // 2. Gera os links
            const linkResponse = await window.CotacaoIndividualScript_apiCall('/api/etapas/gerarLinks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual
                })
            });

            window.CotacaoIndividualScript_mostrarLoadingOverlay(false);
            window.CotacaoIndividualScript_exibirFeedback(linkResponse.message || "Links para fornecedores processados!", false, 7000);
            if (linkResponse.detalhesLinks) {
                console.log("EtapasScript: Detalhes dos Links:", linkResponse.detalhesLinks);
            }

        } catch (error) {
            window.CotacaoIndividualScript_mostrarLoadingOverlay(false);
            window.CotacaoIndividualScript_exibirFeedback("Erro no processo de envio: " + error.message, true, 7000);
        }
    }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 4: REALIZAR COTAÇÃO (Lógica 100% client-side, migração de API abaixo)
    //----------------------------------------------------------------------------------------------------

    // (Funções 100% client-side, sem alteração)
    function EtapasScript_identificarSubprodutosSemPreco() {
        if (!window.CotacaoIndividualScript_dadosOriginaisCotacao) return [];
        return window.CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => {
            const preco = item['Preço'];
            return preco === null || preco === undefined || String(preco).trim() === '' || parseFloat(String(preco).replace(',', '.')) === 0;
        });
    }

    function EtapasScript_renderizarListaSubprodutosSemPreco(subprodutos) {
        const container = document.getElementById('EtapasScript_listaSubprodutosSemPreco');
        container.innerHTML = '';
        if (subprodutos.length === 0) {
            container.innerHTML = `<div class="p-4 text-center text-gray-500">Ótimo! Nenhum subproduto sem preço foi encontrado.</div>`;
            document.getElementById('EtapasScript_btnExcluirSubprodutosSemPreco').textContent = "Iniciar Edição";
            return;
        }
        document.getElementById('EtapasScript_btnExcluirSubprodutosSemPreco').textContent = "Excluir Selecionados e Iniciar Edição";
        subprodutos.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'retirar-subproduto-item py-1';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'checkbox-retirar-subproduto-sem-preco';
            checkbox.dataset.produto = item.Produto;
            checkbox.dataset.subproduto = item.SubProduto;
            checkbox.dataset.fornecedor = item.Fornecedor;
            const label = document.createElement('label');
            label.textContent = ` ${item.Produto} -> ${item.SubProduto} (Fornecedor: ${item.Fornecedor})`;
            label.prepend(checkbox);
            itemDiv.appendChild(label);
            container.appendChild(itemDiv);
        });
    }

    function EtapasScript_desativarModoRealizarCotacao() {
        console.log("EtapasScript: Desativando modo Realizar Cotação.");
        CotacaoIndividualScript_modoEtapaAtual = null;
        document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
        window.CotacaoIndividualScript_restaurarVisualizacaoPadrao(true);
        window.CotacaoIndividualScript_exibirFeedback("Visualização padrão restaurada.", false, 3000);
    }
    
    function EtapasScript_iniciarEdicao() {
        document.getElementById('EtapasScript_realizarCotacaoContainer').classList.add('hidden');
        document.getElementById(window.CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.remove('hidden');
        window.CotacaoIndividualScript_restaurarVisualizacaoPadrao(true);
        window.CotacaoIndividualScript_exibirFeedback("Modo de edição ativado. Clique em uma célula para editar.", false, 6000);
    }

    /**
     * ATUALIZADO: Ponto de entrada da Etapa 4. Chama a API Node.js.
     */
    async function EtapasScript_ativarModoRealizarCotacao() {
        console.log("EtapasScript: Ativando modo Realizar Cotação.");
        CotacaoIndividualScript_modoEtapaAtual = 'realizar_cotacao';

        document.getElementById(window.CotacaoIndividualScript_ID_TABELA_PRODUTOS_COTACAO_CONTAINER).classList.add('hidden');
        document.getElementById(window.CotacaoIndividualScript_ID_RETIRAR_PRODUTOS_CONTAINER).classList.add('hidden');
        document.getElementById(window.CotacaoIndividualScript_ID_GERENCIAR_COTACOES_PORTAL_CONTAINER).classList.add('hidden');
        document.getElementById('EtapasScript_realizarCotacaoContainer').classList.remove('hidden');

        document.getElementById('EtapasScript_btnVoltarEtapa4').addEventListener('click', EtapasScript_desativarModoRealizarCotacao);
        document.getElementById('EtapasScript_btnExcluirSubprodutosSemPreco').addEventListener('click', EtapasScript_manipularExclusaoSubprodutosSemPreco);

        const subprodutosSemPreco = EtapasScript_identificarSubprodutosSemPreco();
        EtapasScript_renderizarListaSubprodutosSemPreco(subprodutosSemPreco);

        window.CotacaoIndividualScript_mostrarLoadingOverlay(true, "Atualizando status...");
        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Realizando Cotação"
                })
            });
            window.CotacaoIndividualScript_mostrarLoadingOverlay(false);
            window.CotacaoIndividualScript_exibirFeedback("Status atualizado para 'Realizando Cotação'.", false, 4000);
        } catch (err) {
            window.CotacaoIndividualScript_mostrarLoadingOverlay(false);
            window.CotacaoIndividualScript_exibirFeedback("Erro ao atualizar status: " + err.message, true);
        }
    }

    /**
     * ATUALIZADO: Manipula a exclusão de subprodutos sem preço. Chama a API Node.js.
     */
    async function EtapasScript_manipularExclusaoSubprodutosSemPreco() {
        const subprodutosParaExcluir = [];
        document.querySelectorAll('.checkbox-retirar-subproduto-sem-preco:checked').forEach(cb => {
            subprodutosParaExcluir.push({
                Produto: cb.dataset.produto,
                SubProdutoChave: cb.dataset.subproduto,
                Fornecedor: cb.dataset.fornecedor
            });
        });

        if (subprodutosParaExcluir.length > 0) {
            window.CotacaoIndividualScript_mostrarLoadingOverlay(true, "Excluindo subprodutos...");
            try {
                const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/retirarSubProdutos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                        subProdutosParaExcluir: subprodutosParaExcluir
                    })
                });
                
                window.CotacaoIndividualScript_exibirFeedback(response.message, false, 4000);
                await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
                window.CotacaoIndividualScript_mostrarLoadingOverlay(false);
                EtapasScript_iniciarEdicao();
                
            } catch (err) {
                window.CotacaoIndividualScript_mostrarLoadingOverlay(false);
                window.CotacaoIndividualScript_exibirFeedback("Erro ao excluir: " + err.message, true);
            }
        } else {
            EtapasScript_iniciarEdicao();
        }
    }

    //----------------------------------------------------------------------------------------------------
    // ETAPA 5: DEFINIR EMPRESA (Lógica de UI/DOM está no EtapasScript_Modal.html, migração da API abaixo)
    //----------------------------------------------------------------------------------------------------
    
    // (Variáveis globais 100% client-side, sem alteração)
    let EtapasScript_empresasParaFaturamento = [];
    let EtapasScript_pedidosMinimosFornecedores = {};
    
    // (Função 100% client-side, sem alteração)
    function EtapasScript_formatarMoeda(numero) {
        if (typeof numero !== 'number') {
            numero = parseFloat(numero) || 0;
        }
        return `R$ ${numero.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
    
    /**
     * ATUALIZADO: Ponto de entrada da Etapa 5 (Modal). Chama a API Node.js.
     */
    async function EtapasScript_ativarModoDefinirEmpresa() {
        console.log("EtapasScript: Ativando modo Definir Empresa (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'definir_empresa';

        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (!modalOverlay) {
            console.error("EtapasScript: Overlay do modal da Etapa 5 não encontrado.");
            window.CotacaoIndividualScript_exibirFeedback("Erro crítico: Componente do modal não encontrado.", true, 0);
            return;
        }
        
        modalOverlay.classList.add('active'); 
        EtapasScript_exibirFeedbackModalDefinirEmpresa("Carregando dados para faturamento...", false, 0);

        try {
            // 1. Atualiza o status
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Definindo Empresa para Faturamento"
                })
            });

            // 2. Busca os dados para o modal
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/dadosFaturamento', {
                method: 'GET'
            });

            EtapasScript_empresasParaFaturamento = response.empresas || [];
            EtapasScript_pedidosMinimosFornecedores = response.pedidosMinimos || {};

            const itensParaComprar = window.CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => {
                const comprarValor = parseFloat(String(item['Comprar'] || '0').replace(',', '.'));
                return comprarValor > 0;
            });
            
            const dadosAgrupadosPorFornecedor = EtapasScript_agruparPorChave(itensParaComprar, 'Fornecedor');
            
            EtapasScript_renderizarTabelaModoFaturamento(dadosAgrupadosPorFornecedor, 'EtapasScript_controlsContainer_Modal', 'EtapasScript_tabelaContainer_Modal');
            
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Selecione a empresa para faturamento de cada item.", false, 8000);

        } catch (err) {
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Erro ao carregar dados: " + err.message, true, 5000);
            setTimeout(EtapasScript_fecharModalDefinirEmpresa, 3000);
        }

        // Configura os botões do modal
        document.getElementById('EtapasScript_btnFecharModalDefinirEmpresa').addEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
        document.getElementById('EtapasScript_btnConcluirModalDefinirEmpresa').addEventListener('click', EtapasScript_fecharModalDefinirEmpresa);
        document.getElementById('EtapasScript_btnSalvarFaturamento').addEventListener('click', EtapasScript_salvarFaturamentoEmLote);
    }
    
    // (Funções 100% client-side, sem alteração)
    function EtapasScript_agruparPorChave(array, chave) {
        return array.reduce((resultado, item) => {
            (resultado[item[chave]] = resultado[item[chave]] || []).push(item);
            return resultado;
        }, {});
    }

    function EtapasScript_exibirFeedbackModalDefinirEmpresa(mensagem, isError = false, duracao = 5000) {
        // (Lógica idêntica à de EtapasScript_exibirFeedbackModalContagem)
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalDefinirEmpresa');
        if (feedbackDiv) { /* ... lógica de exibição ... */ }
    }
    
    function EtapasScript_fecharModalDefinirEmpresa() {
        // (Lógica 100% client-side)
        const modalOverlay = document.getElementById('EtapasScript_modalDefinirEmpresaOverlay');
        if (modalOverlay) modalOverlay.classList.remove('active');
        CotacaoIndividualScript_modoEtapaAtual = null;
        document.getElementById('EtapasScript_controlsContainer_Modal').innerHTML = '';
        document.getElementById('EtapasScript_tabelaContainer_Modal').innerHTML = '';
        document.getElementById('EtapasScript_feedbackModalDefinirEmpresa').innerHTML = '';
    }
    
    function EtapasScript_renderizarTabelaModoFaturamento(dadosAgrupados, controlsContainerId, tableContainerId) {
        // (Lógica 100% client-side, sem alteração)
        // ... todo o código de renderização da tabela ...
    }
    
    function EtapasScript_aplicarEmpresaParaFornecedor(fornecedor, empresa) {
        // (Lógica 100% client-side, sem alteração)
        // ... lógica para aplicar em massa ...
    }
    
    function EtapasScript_atualizarDashboardFornecedor(fornecedor) {
        // (Lógica 100% client-side, sem alteração)
        // ... lógica de recálculo do dashboard do fornecedor ...
    }
    
    function EtapasScript_atualizarDashboardGlobal() {
        // (Lógica 100% client-side, sem alteração)
        // ... lógica de recálculo do dashboard global ...
    }

    /**
     * ATUALIZADO: Coleta e salva as alterações de faturamento na API Node.js.
     */
    async function EtapasScript_salvarFaturamentoEmLote() {
        // 1. Coletar alterações (lógica client-side)
        const alteracoes = [];
        const todasLinhasDoModal = document.querySelectorAll('#EtapasScript_modalDefinirEmpresaOverlay .sub-produto-row');
        todasLinhasDoModal.forEach(row => {
            const identificadores = {
                Produto: row.dataset.produto,
                SubProdutoChave: row.dataset.subprodutoOriginalPersistido,
                Fornecedor: row.dataset.fornecedor
            };
            const itemOriginal = window.CotacaoIndividualScript_dadosOriginaisCotacao.find(item => 
                item.Produto === identificadores.Produto &&
                item._subProdutoOriginalPersistido === identificadores.SubProdutoChave &&
                item.Fornecedor === identificadores.Fornecedor
            );
            const selectEmpresa = row.querySelector('td[data-coluna="Empresa Faturada"] select');
            if (selectEmpresa && itemOriginal) {
                const novaEmpresa = selectEmpresa.value;
                const empresaOriginal = itemOriginal["Empresa Faturada"] || "";
                if (novaEmpresa !== empresaOriginal) {
                    alteracoes.push({ ...identificadores, "Empresa Faturada": novaEmpresa });
                }
            }
        });

        if (alteracoes.length === 0) {
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Nenhuma alteração foi feita para salvar.", false, 4000);
            return;
        }

        // 2. Enviar para API
        const btnSalvar = document.getElementById('EtapasScript_btnSalvarFaturamento');
        btnSalvar.disabled = true;
        btnSalvar.textContent = 'Salvando...';
        EtapasScript_exibirFeedbackModalDefinirEmpresa(`Salvando ${alteracoes.length} alteraçõe(s)...`, false, 0);

        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/salvarFaturamento', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    alteracoes: alteracoes
                })
            });

            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar e Fechar';
            EtapasScript_fecharModalDefinirEmpresa();
            window.CotacaoIndividualScript_exibirFeedback(response.message || "Faturamento salvo!", false, 5000);
            
            // Recarrega os dados da cotação
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);

        } catch (error) {
            btnSalvar.disabled = false;
            btnSalvar.textContent = 'Salvar e Fechar';
            EtapasScript_exibirFeedbackModalDefinirEmpresa("Erro ao salvar: " + error.message, true, 7000);
        }
    }


    //----------------------------------------------------------------------------------------------------
    // ETAPA 6: DEFINIR CONDIÇÕES DE PAGAMENTO (MODAL)
    //----------------------------------------------------------------------------------------------------

    // (Variável 100% client-side, sem alteração)
    let EtapasScript_debounceTimer = null;

    // (Funções 100% client-side, sem alteração)
    function EtapasScript_exibirFeedbackModalCondicoes(mensagem, isError = false, duracao = 5000) {
        const feedbackDiv = document.getElementById('EtapasScript_feedbackModalCondicoes');
        if (feedbackDiv) { /* ... lógica de exibição ... */ }
    }
    
    function EtapasScript_fecharModalCondicoesPagamento() {
        // (Lógica 100% client-side)
        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        if (modalOverlay) modalOverlay.classList.remove('active');
        CotacaoIndividualScript_modoEtapaAtual = null;
        document.getElementById('EtapasScript_feedbackModalCondicoes').innerHTML = '';
    }
    
    function EtapasScript_renderizarInterfaceCondicoesPagamento(itensParaComprar, condicoesFornecedores, pedidosListContainerId) {
        // (Lógica 100% client-side, sem alteração)
        // ... todo o código de renderização da interface ...
    }

    function EtapasScript_atualizarFluxoCaixaGeral() {
        // (Lógica 100% client-side, sem alteração)
        // ... todo o código de cálculo e renderização do fluxo de caixa ...
    }

    /**
     * ATUALIZADO: Ponto de entrada da Etapa 6 (Modal). Chama a API Node.js.
     */
    async function EtapasScript_ativarModoDefinirCondicoesPagamento() {
        console.log("EtapasScript: Ativando modo Definir Condições de Pagamento (Modal).");
        CotacaoIndividualScript_modoEtapaAtual = 'definir_condicoes_pagamento';

        const itensParaComprar = window.CotacaoIndividualScript_dadosOriginaisCotacao.filter(item => 
            (parseFloat(String(item['Comprar'] || '0').replace(',', '.')) || 0) > 0
        );
        const itemSemEmpresa = itensParaComprar.find(item => !item['Empresa Faturada']);
        if (itemSemEmpresa) {
            window.CotacaoIndividualScript_exibirFeedback("Erro: Complete a Etapa 5 (Definir Empresa) primeiro.", true, 8000);
            CotacaoIndividualScript_modoEtapaAtual = null;
            return;
        }

        const modalOverlay = document.getElementById('EtapasScript_modalCondicoesPagamentoOverlay');
        modalOverlay.classList.add('active');
        EtapasScript_exibirFeedbackModalCondicoes("Carregando dados de pagamento...", false, 0);
        document.getElementById('etapa6-pedidos-list-modal').innerHTML = '<p class="text-gray-500 text-center p-4">Carregando...</p>';

        document.getElementById('EtapasScript_btnFecharModalCondicoes').addEventListener('click', EtapasScript_fecharModalCondicoesPagamento);
        document.getElementById('EtapasScript_btnCancelarModalCondicoes').addEventListener('click', EtapasScript_fecharModalCondicoesPagamento);
        document.getElementById('EtapasScript_btnSalvarModalCondicoes').addEventListener('click', EtapasScript_salvarDadosCondicoesPagamento);

        try {
            // 1. Atualiza o status
            await window.CotacaoIndividualScript_apiCall('/api/etapas/atualizarStatus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    novoStatus: "Definindo Condições de Pagamento"
                })
            });

            // 2. Busca os dados das condições
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/dadosCondicoes', {
                method: 'GET'
            });

            EtapasScript_renderizarInterfaceCondicoesPagamento(itensParaComprar, response.condicoes || {}, 'etapa6-pedidos-list-modal');
            EtapasScript_exibirFeedbackModalCondicoes("", false, 1);

        } catch (err) {
            EtapasScript_exibirFeedbackModalCondicoes("Erro ao carregar dados: " + err.message, true, 5000);
            setTimeout(EtapasScript_fecharModalCondicoesPagamento, 3000);
        }
    }

    /**
     * ATUALIZADO: Coleta e salva as condições de pagamento na API Node.js.
     */
    async function EtapasScript_salvarDadosCondicoesPagamento() {
        console.log("EtapasScript: Salvando condições de pagamento do modal...");
        const dadosParaSalvar = [];
        let primeiroCampoVazio = null;
        
        document.querySelectorAll('#etapa6-pedidos-list-modal .etapa6-pedido-item').forEach(item => {
            const fornecedor = item.dataset.fornecedor;
            const empresa = item.dataset.empresa;
            const condicaoInput = item.querySelector('input[type="text"]');
            const condicao = condicaoInput.value.trim();

            if (condicao === '') {
                if (!primeiroCampoVazio) primeiroCampoVazio = condicaoInput;
            }
            dadosParaSalvar.push({ fornecedor, empresa, condicao });
        });

        if (primeiroCampoVazio) {
            EtapasScript_exibirFeedbackModalCondicoes("Erro: Todas as condições de pagamento devem ser preenchidas.", true, 5000);
            primeiroCampoVazio.focus();
            return;
        }
        if (dadosParaSalvar.length === 0) {
            EtapasScript_exibirFeedbackModalCondicoes("Não há pedidos para salvar.", false, 4000);
            return;
        }

        const btnSalvar = document.getElementById('EtapasScript_btnSalvarModalCondicoes');
        btnSalvar.disabled = true;
        btnSalvar.textContent = "Salvando...";
        EtapasScript_exibirFeedbackModalCondicoes("Salvando condições...", false, 0);

        try {
            const response = await window.CotacaoIndividualScript_apiCall('/api/etapas/salvarCondicoes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idCotacao: window.CotacaoIndividualScript_cotacaoIdAtual,
                    dadosPagamento: dadosParaSalvar
                })
            });

            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar Condições";
            EtapasScript_fecharModalCondicoesPagamento();
            window.CotacaoIndividualScript_exibirFeedback(response.message, false, 6000);
            
            // Recarrega os dados da cotação
            await window.CotacaoIndividualScript_carregarDadosCotacao(window.CotacaoIndividualScript_cotacaoIdAtual);
            
        } catch (error) {
            btnSalvar.disabled = false;
            btnSalvar.textContent = "Salvar Condições";
            EtapasScript_exibirFeedbackModalCondicoes("Erro ao salvar: " + error.message, true);
        }
    }


    //----------------------------------------------------------------------------------------------------
    // ETAPA 7: IMPRIMIR PEDIDOS
    //----------------------------------------------------------------------------------------------------

    /**
     * ATUALIZADO: Abre a página de impressão (View) do Node.js.
     * Não precisa mais chamar o backend, apenas constrói a URL.
     */
    function EtapasScript_abrirPaginaImpressao() {
        console.log("EtapasScript: Solicitando abertura da página de impressão.");
        
        const idCotacao = window.CotacaoIndividualScript_cotacaoIdAtual;
        if (!idCotacao) {
            window.CotacaoIndividualScript_exibirFeedback("Erro: ID da Cotação não encontrado.", true, 5000);
            return;
        }
        
        // Constrói a URL da view do Node.js
        const url = `/view/ImprimirPedidosView?idCotacao=${encodeURIComponent(idCotacao)}`;
        
        console.log(`Abrindo URL: ${url}`);
        window.open(url, '_blank');
    }
</script>